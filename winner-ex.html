<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë‹¹ì²¨ì ì¶”ì²¨ê¸° Â· ë¡œì»¬ ì›¹</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#fafafa; --card:#fff; --text:#111; --subtext:#666;
    --primary:#111; --accent:#2563eb; --border:#e5e7eb;
    --shadow:0 10px 30px rgba(0,0,0,.06); --radius:16px;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0c0f; --card:#121418; --text:#e5e7eb; --subtext:#9aa2b1;
      --primary:#e5e7eb; --accent:#3b82f6; --border:#1f2430; --shadow:0 10px 30px rgba(0,0,0,.4) }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
  header h1{font-size:22px;margin:0}
  header .badge{font-size:12px;color:var(--accent);
    background:color-mix(in oklab,var(--accent) 12%,transparent);
    padding:6px 10px;border-radius:999px;
    border:1px solid color-mix(in oklab,var(--accent) 35%,transparent)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    box-shadow:var(--shadow);padding:18px;margin:14px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:880px){.row,.grid2{grid-template-columns:1fr}}
  label{font-size:14px;display:flex;flex-direction:column;gap:6px}
  input[type="text"],input[type="number"],.pill{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
    background:transparent;color:var(--text)}
  .hint{color:var(--subtext);font-size:13px;margin-top:6px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
  .btn{background:var(--primary);color:var(--card)}
  .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .radio-row{display:flex;gap:18px;flex-wrap:wrap}
  .drop{border:2px dashed var(--border);border-radius:16px;padding:20px;text-align:center;transition:.2s background}
  .drop.drag{background:color-mix(in oklab,var(--accent) 10%,transparent)}
  .kicker{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--accent);font-weight:700;margin-bottom:6px}
  .log{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:13px;white-space:pre-wrap;
    background:color-mix(in oklab,var(--card) 60%,transparent);border-radius:12px;padding:12px;border:1px dashed var(--border)}
  footer{margin:18px 0 40px;text-align:right;color:var(--subtext);font-size:12px}
  .switch{display:flex;align-items:center;gap:8px}
  .switch input{width:18px;height:18px}
  .pill{display:flex;align-items:center;gap:8px;justify-content:center}
  .pill input[type="file"]{display:none}
  .pill .fake{display:inline-flex;gap:8px;align-items:center}
  .section-title{font-weight:800;font-size:13px;color:var(--accent);letter-spacing:.08em;margin:10px 0 6px}
  .subcard{border:1px dashed var(--border);border-radius:14px;padding:14px}
</style>
<!-- SheetJS & seedrandom -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/seedrandom@3.0.5/seedrandom.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="kicker">EVENT WINNERS</div>
      <h1>ì´ë²¤íŠ¸ ë‹¹ì²¨ì ì¶”ì²¨ê¸°</h1>
    </div>
    <div class="badge">Client-only Â· Privacy-safe</div>
  </header>

  <!-- ì—…ë¡œë“œ: ì°¸ì—¬ì / ì œì™¸ì ë¶„ë¦¬ -->
  <section class="card">
    <div class="kicker">UPLOAD</div>
    <div class="grid2">
      <!-- ì°¸ì—¬ì -->
      <div class="subcard">
        <div class="section-title">ì°¸ì—¬ì ë¦¬ìŠ¤íŠ¸ íŒŒì¼ ì„ íƒ</div>
        <div id="drop" class="drop">
          <strong>ì—‘ì…€ íŒŒì¼ ë“œë˜ê·¸&ë“œë¡­</strong><br/>
          <span class="hint">ë˜ëŠ” ì•„ë˜ì—ì„œ íŒŒì¼ ì„ íƒ</span>
        </div>
        <label style="margin-top:10px">
          <span>ì°¸ì—¬ì ì—‘ì…€ ì„ íƒ</span>
          <span class="pill"><label class="fake btn secondary"><input type="file" id="fileInput" accept=".xlsx,.xls" />íŒŒì¼ ì„ íƒ</label></span>
        </label>

        <div class="switch" style="margin-top:10px">
          <input type="checkbox" id="headerless">
          <label for="headerless" style="margin:0">ì²« í–‰ì— ì—´ë¨¸ë¦¬ê¸€ ì—†ìŒ(ì°¸ì—¬ìë§Œ: ì´ë¦„, id, ì „í™”ë²ˆí˜¸ ìˆœ)</label>
        </div>
        <div class="row" style="margin-top:10px">
          <label>ì „ì²´ ì°¸ì—¬ì ì‹œíŠ¸ëª…
            <input type="text" id="sheetJoined" value="joined_all" placeholder="ì˜ˆ: joined_all ë˜ëŠ” sheet1" />
          </label>
          <label>ë‹¹í•´ ì´ë²¤íŠ¸ ì°¸ì—¬ì ì‹œíŠ¸ëª…
            <input type="text" id="sheetOnly" value="only_joined" placeholder="ì˜ˆ: only_joined" />
          </label>
        </div>
        <div class="hint">ì‹œíŠ¸ëª…ì€ ì…ë ¥í•œ ê°’ê³¼ <b>ì •í™•íˆ ì¼ì¹˜</b>í•˜ëŠ” ì‹œíŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì˜ˆ: <b>sheet1</b>ë¼ê³  ì…ë ¥í•˜ë©´ sheet1ì„ ì°¾ìŠµë‹ˆë‹¤.</div>
      </div>

      <!-- ì œì™¸ì -->
      <div class="subcard">
        <div class="section-title">ì œì™¸ì ë¦¬ìŠ¤íŠ¸ íŒŒì¼ ì„ íƒ</div>
        <div id="dropEx" class="drop">
          <strong>ì œì™¸ì ì—‘ì…€ ë“œë˜ê·¸&ë“œë¡­</strong><br/>
          <span class="hint">ì„ íƒì‚¬í•­ Â· í—¤ë” í¬í•¨ [ì´ë¦„, id, ì „í™”ë²ˆí˜¸]</span>
        </div>
        <label style="margin-top:10px">
          <span>ì œì™¸ì ì—‘ì…€ ì„ íƒ(ì„ íƒ)</span>
          <span class="pill"><label class="fake btn secondary"><input type="file" id="fileInputEx" accept=".xlsx,.xls" />íŒŒì¼ ì„ íƒ</label></span>
        </label>

        <label style="margin-top:10px">ì œì™¸ì ì‹œíŠ¸ëª…
          <input type="text" id="sheetExclude" value="exclude_list" placeholder="ì˜ˆ: exclude_list" />
        </label>

        <label style="margin-top:10px">ëœë¤ ì‹œë“œ (0~10000)
          <input type="number" id="seed" min="0" max="10000" placeholder="ë¹„ìš°ë©´ ìë™ ëœë¤" />
        </label>
        <div class="hint">ğŸ’¡ ì‹œë“œê°’ì€ ì¶”ì²¨ ê²°ê³¼ë¥¼ ê³ ì •í•˜ê¸° ìœ„í•œ ìˆ«ìì…ë‹ˆë‹¤. ê°™ì€ ë°ì´í„° + ê°™ì€ ì‹œë“œ = ê°™ì€ ê²°ê³¼.</div>
      </div>
    </div>
  </section>

  <!-- ëª¨ë“œ -->
  <section class="card">
    <div class="kicker">MODE</div>
    <div class="radio-row">
      <label><input type="radio" name="mode" value="dual" checked> ì´ì¤‘ ì¶”ì²¨(ì¤‘ë³µ ê°€ëŠ¥)</label>
      <label><input type="radio" name="mode" value="single"> ë‹¨ì¼ ì¶”ì²¨(í•œ ì‹œíŠ¸ì—ì„œ Nëª…)</label>
    </div>

    <div id="dualConfig" style="margin-top:12px">
      <div class="row">
        <label>ì „ì²´ ì°¸ì—¬ì ì¶”ì²¨ ì¸ì› (A)<input type="number" id="nJoined" value="125" min="0" /></label>
        <label>ë‹¹í•´ ì´ë²¤íŠ¸ ìµœì¢… ì¸ì› (B)<input type="number" id="nTotalOther" value="1000" min="0" /></label>
      </div>
      <div class="row">
        <label>ë‘ ìƒí’ˆ ì¤‘ë³µ ì¸ì› (O)<input type="number" id="nOverlap" value="20" min="0" /></label>
        <div></div>
      </div>
    </div>

    <div id="singleConfig" style="display:none;margin-top:12px">
      <div class="row">
        <label>ì‹œíŠ¸ëª…<input type="text" id="sheetSingle" value="joined_all" placeholder="ì˜ˆ: joined_all ë˜ëŠ” sheet1" /></label>
        <label>ì¶”ì²¨ ì¸ì›<input type="number" id="nSingle" value="100" min="1" /></label>
      </div>
    </div>

    <div class="toolbar" style="margin-top:14px">
      <button id="runBtn" class="btn">ì¶”ì²¨ ì‹¤í–‰</button>
      <button id="downloadBtn" class="btn secondary" disabled>ì›ë³¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
      <button id="downloadMaskedBtn" class="btn secondary" disabled>ë§ˆìŠ¤í‚¹ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
    </div>
    <div class="hint" style="margin-top:6px">ì›ë³¸ ê²°ê³¼ í™•ì¸ í›„ ê°œì¸ì •ë³´ê°€ í¬í•¨ëœ ë°°í¬ìš©ìœ¼ë¡œëŠ” â€œë§ˆìŠ¤í‚¹ ê²°ê³¼ ë‹¤ìš´ë¡œë“œâ€ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</div>
  </section>

  <!-- ë¡œê·¸ -->
  <section class="card">
    <div class="kicker">LOG</div>
    <div id="log" class="log">ì¤€ë¹„ë¨.</div>
  </section>

  <footer>â“’ Jeongyeon. 2025</footer>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const logBox = $('#log');

  // íŒŒì¼ ì…ë ¥
  const fileInput = $('#fileInput'), drop = $('#drop');
  const fileInputEx = $('#fileInputEx'), dropEx = $('#dropEx');

  // ì„¤ì •
  const headerless = $('#headerless');
  const sheetJoined = $('#sheetJoined');
  const sheetOnly = $('#sheetOnly');
  const sheetExclude = $('#sheetExclude');
  const seedInput = $('#seed');

  // ëª¨ë“œ/ìˆ˜ëŸ‰
  const modeRadios = document.getElementsByName('mode');
  const dualConfig = $('#dualConfig'), singleConfig = $('#singleConfig');
  const nJoined = $('#nJoined'), nTotalOther = $('#nTotalOther'), nOverlap = $('#nOverlap');
  const sheetSingle = $('#sheetSingle'), nSingle = $('#nSingle');

  // ë²„íŠ¼
  const runBtn = $('#runBtn'), downloadBtn = $('#downloadBtn'), downloadMaskedBtn = $('#downloadMaskedBtn');

  let resultsWB = null, resultsWBMasked = null;

  function setLog(m){ logBox.textContent = m; }
  function addLog(m){ logBox.textContent += (logBox.textContent? "\n":"") + m; }
  function getMode(){ return [...modeRadios].find(r=>r.checked).value; }

  // Drag & Drop (ì°¸ì—¬ì)
  ;['dragenter','dragover'].forEach(evt=>drop.addEventListener(evt,e=>{e.preventDefault();drop.classList.add('drag');}));
  ;['dragleave','drop'].forEach(evt=>drop.addEventListener(evt,e=>{e.preventDefault();drop.classList.remove('drag');}));
  drop.addEventListener('drop', e=>{ const f=e.dataTransfer.files?.[0]; if(f){ fileInput.files=e.dataTransfer.files; addLog(`ì°¸ì—¬ì íŒŒì¼ ì„ íƒ: ${f.name}`); }});

  // Drag & Drop (ì œì™¸ì)
  ;['dragenter','dragover'].forEach(evt=>dropEx.addEventListener(evt,e=>{e.preventDefault();dropEx.classList.add('drag');}));
  ;['dragleave','drop'].forEach(evt=>dropEx.addEventListener(evt,e=>{e.preventDefault();dropEx.classList.remove('drag');}));
  dropEx.addEventListener('drop', e=>{ const f=e.dataTransfer.files?.[0]; if(f){ fileInputEx.files=e.dataTransfer.files; addLog(`ì œì™¸ì íŒŒì¼ ì„ íƒ: ${f.name}`); }});

  // ëª¨ë“œ í† ê¸€
  [...modeRadios].forEach(r => r.addEventListener('change', ()=>{
    const mode = getMode();
    if(mode==='dual'){ dualConfig.style.display=''; singleConfig.style.display='none'; }
    else { dualConfig.style.display='none'; singleConfig.style.display=''; }
  }));

  // ì‹œë“œ
  function resolveSeed(){
    let s = seedInput.value.trim();
    if(s === ''){
      const auto = Math.floor(Math.random()*10001);
      seedInput.value = String(auto);
      return auto;
    }
    const v = parseInt(s,10);
    if(isNaN(v) || v<0 || v>10000) throw new Error('ì‹œë“œëŠ” 0~10000 ì •ìˆ˜ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
    return v;
  }

  // ë§ˆìŠ¤í‚¹
  const maskName = name => !name ? '' : (String(name).length<=1? '*' : (String(name).length===2? String(name)[0]+'*' : String(name)[0]+'*'+String(name).slice(-1)));
  const maskId = id => !id ? '' : (String(id).length<=3? '***' : String(id).slice(0, -3)+'***');
  function maskPhone(phone){
    if(!phone) return '';
    const s = String(phone);
    const m = s.match(/^(\d{2,3})-(\d{3,4})-(\d{4})$/);
    if(m) return `${m[1]}-****-${m[3]}`;
    return s.replace(/\d(?=\d{4})/g,'*');
  }

  const toSheet = rows => XLSX.utils.json_to_sheet(rows.map(r=>({ì´ë¦„:r.ì´ë¦„||'', id:r.id||'', ì „í™”ë²ˆí˜¸:r.ì „í™”ë²ˆí˜¸||''})));
  const toSheetMasked = rows => XLSX.utils.json_to_sheet(rows.map(r=>({ì´ë¦„:maskName(r.ì´ë¦„||''), id:maskId(r.id||''), ì „í™”ë²ˆí˜¸:maskPhone(r.ì „í™”ë²ˆí˜¸||'')})));

  // ì½ê¸°
  function readSheet(ws, hasHeader){
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:false, defval:''});
    const out=[];
    if(hasHeader){
      const header=(rows[0]||[]).map(s=>String(s||'').trim());
      const iN=header.findIndex(h=>h==='ì´ë¦„'||/name/i.test(h));
      const iI=header.findIndex(h=>h==='id'||/^ID$/i.test(h));
      const iP=header.findIndex(h=>h==='ì „í™”ë²ˆí˜¸'||/phone|tel/i.test(h));
      if(iN<0||iI<0||iP<0) throw new Error('í—¤ë”ê°€ ìˆëŠ” ê²½ìš°, ìµœì†Œ [ì´ë¦„, id, ì „í™”ë²ˆí˜¸]ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
      for(let i=1;i<rows.length;i++){ const r=rows[i]||[];
        out.push({ì´ë¦„:String(r[iN]||'').trim()||undefined, id:String(r[iI]||'').trim()||undefined, ì „í™”ë²ˆí˜¸:String(r[iP]||'').trim()||undefined});
      }
    }else{
      for(const r of rows){ if(!r) continue;
        out.push({ì´ë¦„:String((r[0]??'')).trim()||undefined, id:String((r[1]??'')).trim()||undefined, ì „í™”ë²ˆí˜¸:String((r[2]??'')).trim()||undefined});
      }
    }
    return out;
  }
  function readExcludeSheet(ws){
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:false, defval:''});
    const out=[]; const header=(rows[0]||[]).map(s=>String(s||'').trim());
    const iN=header.findIndex(h=>h==='ì´ë¦„'||/name/i.test(h));
    const iI=header.findIndex(h=>h==='id'||/^ID$/i.test(h));
    const iP=header.findIndex(h=>h==='ì „í™”ë²ˆí˜¸'||/phone|tel/i.test(h));
    if(iN<0||iI<0||iP<0) throw new Error('exclude_list ì‹œíŠ¸ì—ëŠ” [ì´ë¦„, id, ì „í™”ë²ˆí˜¸] í—¤ë”ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    for(let i=1;i<rows.length;i++){ const r=rows[i]||[];
      out.push({ì´ë¦„:String(r[iN]||'').trim()||undefined, id:String(r[iI]||'').trim()||undefined, ì „í™”ë²ˆí˜¸:String(r[iP]||'').trim()||undefined});
    }
    return out;
  }

  // í‚¤/ìœ í‹¸
  const makeKey = o => o.id ? `id|${o.id}` : (o.ì „í™”ë²ˆí˜¸ ? `phone|${o.ì „í™”ë²ˆí˜¸}` : `namecombo|${o.ì´ë¦„||''}|${o.ì „í™”ë²ˆí˜¸||''}`);
  function uniqueByKey(arr){ const seen=new Set(), out=[]; for(const o of arr){ const k=makeKey(o); if(!seen.has(k)){seen.add(k); out.push({...o,_key:k});}} return out; }
  function sampleKeys(keysArr, n, rng){
    if(n<0) throw new Error('ì¶”ì²¨ ì¸ì›ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    if(keysArr.length<n) throw new Error(`ì¶”ì²¨ ì¸ì›ì´ ë°ì´í„°ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤. ë°ì´í„° ${keysArr.length} / ìš”ì²­ ${n}`);
    const a=keysArr.slice();
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a.slice(0,n);
  }
  const shuffleRows = (rows, rng) => { const a=rows.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; };

  // [NEW] ì •ë ¬ëœ í‚¤ ë°°ì—´ (ì‹œë“œ ì¬í˜„ì„± ë³´ì¥)
  const orderedKeysFromRows = rows => rows.map(r=>r._key).slice().sort();

  // [NEW] ê²€ì¦ ë¡œê·¸ ìœ í‹¸
  function logExclusionStats({poolName, poolRows, winnersRows, excludeSet}) {
    const inPool = poolRows.filter(r => excludeSet.has(r._key)).length;
    const inWinners = winnersRows.filter(r => excludeSet.has(r._key)).length;
    addLog(`ğŸ” ê²€ì¦[${poolName}]: í›„ë³´í’€ êµì§‘í•© ${inPool}ëª… / ë‹¹ì²¨ì í¬í•¨ ${inWinners}ëª…`);
    return { inPool, inWinners };
  }

  // ì‹¤í–‰
  $('#runBtn').addEventListener('click', async ()=>{
    try{
      setLog('ì‹¤í–‰ ì¤‘â€¦');
      downloadBtn.disabled = true; downloadMaskedBtn.disabled = true;
      resultsWB = XLSX.utils.book_new(); resultsWBMasked = XLSX.utils.book_new();

      if(!fileInput.files[0]) throw new Error('ì°¸ì—¬ì ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
      const buf = await fileInput.files[0].arrayBuffer();
      const wb = XLSX.read(buf, {type:'array'});

      // ì œì™¸ ë¡œë“œ(ì„ íƒ)
      let excludeSet = new Set(), excludeRows=[];
      if(fileInputEx.files[0]){
        const bufEx = await fileInputEx.files[0].arrayBuffer();
        const wbEx = XLSX.read(bufEx, {type:'array'});
        const wsEx = wbEx.Sheets[sheetExclude.value.trim()];
        if(!wsEx) throw new Error(`ì œì™¸ì ì‹œíŠ¸ ì—†ìŒ: ${sheetExclude.value}`);
        const exArrRaw = readExcludeSheet(wsEx);
        const exUniq = uniqueByKey(exArrRaw);
        excludeSet = new Set(exUniq.map(r=>r._key));
        excludeRows = exUniq;
        addLog(`ì œì™¸ì ${excludeSet.size}ëª… ë¡œë“œë¨.`);
      } else {
        addLog('ì œì™¸ì íŒŒì¼ ë¯¸ì„ íƒ: ì œì™¸ ì—†ì´ ì§„í–‰í•©ë‹ˆë‹¤.');
      }

      const hasHeader = !headerless.checked;
      const seed = resolveSeed();
      const rng = new Math.seedrandom(String(seed));
      const applyExclude = arr => arr.filter(r=>!excludeSet.has(r._key));

      if(getMode()==='single'){
        const sname = sheetSingle.value.trim();
        const ws = wb.Sheets[sname];
        if(!ws) throw new Error(`ì‹œíŠ¸ ì—†ìŒ: ${sname}`);
        let arr = uniqueByKey(readSheet(ws, hasHeader));
        const before = arr.length; arr = applyExclude(arr); const after = arr.length;
        addLog(`ë‹¨ì¼ëª¨ë“œ: ì œì™¸ ì ìš© ${before - after}ëª… ì œì™¸ë¨. (ì”ì—¬ ${after})`);

        const n = parseInt(nSingle.value,10);
        const pick = sampleKeys(orderedKeysFromRows(arr), n, rng);  // ì •ë ¬ëœ í‚¤ë¡œ ìƒ˜í”Œ
        const winners = shuffleRows(arr.filter(r=>pick.includes(r._key)), rng);

        // ê²€ì¦ ë¡œê·¸ + ì‹œíŠ¸
        const statsSingle = logExclusionStats({poolName:sname, poolRows:arr, winnersRows:winners, excludeSet});
        if (statsSingle.inWinners > 0) {
          const hits = winners.filter(w=>excludeSet.has(w._key));
          XLSX.utils.book_append_sheet(resultsWB, toSheet(hits), 'excluded_hits(ê²€ì¦)');
          XLSX.utils.book_append_sheet(resultsWBMasked, toSheetMasked(hits), 'excluded_hits(ê²€ì¦)_masked');
        } else {
          addLog('âœ… ê²€ì¦ ì™„ë£Œ: ì œì™¸ì 0ëª… í¬í•¨.');
        }

        XLSX.utils.book_append_sheet(resultsWB, toSheet(winners), 'winners_single');
        XLSX.utils.book_append_sheet(resultsWBMasked, toSheetMasked(winners), 'winners_single(masked)');
        setLog(`ë‹¨ì¼ ì¶”ì²¨ ì™„ë£Œ: ${winners.length}ëª…\nì‹œë“œ: ${seed}`);

      } else {
        const wsJ = wb.Sheets[sheetJoined.value.trim()];
        const wsO = wb.Sheets[sheetOnly.value.trim()];
        if(!wsJ) throw new Error(`ì‹œíŠ¸ ì—†ìŒ: ${sheetJoined.value}`);
        if(!wsO) throw new Error(`ì‹œíŠ¸ ì—†ìŒ: ${sheetOnly.value}`);

        // ì›ë³¸
        let joinedArr = uniqueByKey(readSheet(wsJ, hasHeader));
        let onlyArr   = uniqueByKey(readSheet(wsO, hasHeader));

        // ì œì™¸ ì ìš©
        const beforeJ=joinedArr.length, beforeO=onlyArr.length;
        joinedArr = applyExclude(joinedArr);
        onlyArr   = applyExclude(onlyArr);
        addLog(`ì´ì¤‘ëª¨ë“œ: ì œì™¸ ì ìš© joined_all ${beforeJ - joinedArr.length}ëª…, only_joined ${beforeO - onlyArr.length}ëª… ì œì™¸ë¨.`);

        // ì •ë ¬ëœ í‚¤ë¡œ ê³ ì •
        const joinedKeysArr = orderedKeysFromRows(joinedArr);
        const joinedKeySet  = new Set(joinedKeysArr);
        const onlyKeysArr   = orderedKeysFromRows(onlyArr).filter(k=>!joinedKeySet.has(k)); // ì •ë ¬+ì°¨ì§‘í•©

        const A = parseInt(nJoined.value,10);
        const B = parseInt(nTotalOther.value,10);
        const O = parseInt(nOverlap.value,10);
        if(O > B) throw new Error('ì¤‘ë³µ ì¸ì›ì´ ìµœì¢… ì¸ì›ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        const needOnly = B - O;

        if(joinedKeysArr.length < A) throw new Error(`ì „ì²´ ì°¸ì—¬ì ë¶€ì¡±: ${joinedKeysArr.length} / í•„ìš” ${A}`);
        if(onlyKeysArr.length < needOnly) throw new Error(`ì •ì œëœ ë‹¹í•´ ì´ë²¤íŠ¸ ì°¸ì—¬ì ë¶€ì¡±: ${onlyKeysArr.length} / í•„ìš” ${needOnly}`);

        // ìƒ˜í”Œë§
        const joinedPick  = sampleKeys(joinedKeysArr, A, rng);
        const overlapPick = O>0 ? sampleKeys(joinedPick, O, rng) : [];
        const onlyPick    = sampleKeys(onlyKeysArr, needOnly, rng);
        const finalOther  = [...onlyPick, ...overlapPick];

        const byKey = arr => Object.fromEntries(arr.map(r=>[r._key,r]));
        const J = byKey(joinedArr), OJ = byKey([...onlyArr, ...joinedArr]);

        const winnersA = shuffleRows(joinedPick.map(k=>J[k]), rng);
        const winnersB = shuffleRows(finalOther.map(k=>OJ[k]), rng);

        // ê²€ì¦ ë¡œê·¸ + ì‹œíŠ¸
        const statsA = logExclusionStats({poolName:'ì „ì²´ì°¸ì—¬í’€(A)', poolRows:joinedArr, winnersRows:winnersA, excludeSet});
        const statsB = logExclusionStats({poolName:'ë‹¹í•´ì´ë²¤íŠ¸í’€(B)', poolRows:onlyArr, winnersRows:winnersB, excludeSet});
        const totalHits = winnersA.filter(w=>excludeSet.has(w._key)).concat(winnersB.filter(w=>excludeSet.has(w._key)));
        if(totalHits.length>0){
          addLog(`âš ï¸ ê²½ê³ : ìµœì¢… ë‹¹ì²¨ì ì¤‘ ì œì™¸ì ${totalHits.length}ëª… ë°œê²¬ â†’ ê²°ê³¼ íŒŒì¼ì— 'excluded_hits(ê²€ì¦)' ì‹œíŠ¸ë¡œ ì €ì¥`);
          XLSX.utils.book_append_sheet(resultsWB, toSheet(totalHits), 'excluded_hits(ê²€ì¦)');
          XLSX.utils.book_append_sheet(resultsWBMasked, toSheetMasked(totalHits), 'excluded_hits(ê²€ì¦)_masked');
        } else {
          addLog('âœ… ê²€ì¦ ì™„ë£Œ: ì œì™¸ì 0ëª… í¬í•¨.');
        }

        // ê²°ê³¼
        XLSX.utils.book_append_sheet(resultsWB, toSheet(winnersA), 'winners_A(ì „ì²´ì°¸ì—¬)');
        XLSX.utils.book_append_sheet(resultsWB, toSheet(winnersB), 'winners_B(ë‹¹í•´ì´ë²¤íŠ¸)');
        XLSX.utils.book_append_sheet(resultsWBMasked, toSheetMasked(winnersA), 'winners_A(ì „ì²´ì°¸ì—¬_masked)');
        XLSX.utils.book_append_sheet(resultsWBMasked, toSheetMasked(winnersB), 'winners_B(ë‹¹í•´ì´ë²¤íŠ¸_masked)');
        setLog(`ì´ì¤‘ ì¶”ì²¨ ì™„ë£Œ(ì œì™¸ ë°˜ì˜): A=${winnersA.length}ëª…, B=${winnersB.length}ëª…\nì‹œë“œ: ${seed}`);
      }

      downloadBtn.disabled = false; downloadMaskedBtn.disabled = false;
    }catch(err){
      resultsWB = null; resultsWBMasked = null;
      downloadBtn.disabled = true; downloadMaskedBtn.disabled = true;
      setLog('âŒ ì˜¤ë¥˜: ' + err.message);
      console.error(err);
    }
  });

  // ë‹¤ìš´ë¡œë“œ
  function tsName(prefix){ const t=new Date(), pad=n=>String(n).padStart(2,'0');
    return `${prefix}_${t.getFullYear()}${pad(t.getMonth()+1)}${pad(t.getDate())}_${pad(t.getHours())}${pad(t.getMinutes())}${pad(t.getSeconds())}.xlsx`; }
  $('#downloadBtn').addEventListener('click', ()=>{ if(resultsWB) XLSX.writeFile(resultsWB, tsName('winners')); });
  $('#downloadMaskedBtn').addEventListener('click', ()=>{ if(resultsWBMasked) XLSX.writeFile(resultsWBMasked, tsName('winners_masked')); });
})();
</script>
</body>
</html>