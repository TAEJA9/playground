<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yí´ë¼ìš°ë“œ ë¬¸ì œì€í–‰ íŒŒì¼ ê²€ì‚¬ê¸° (ì›¹ë²„ì „)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
<style>
:root{
  --bg:#0f172a;--panel:#1f2937;--ink:#e5e7eb;--ink-dim:#94a3b8;--accent:#60a5fa;--card:#111827;
  --border:#334155; --thead:#334155; --btn-ink:#0b1220; --rowh:36px;
}
:root[data-theme="light"]{
  --bg:#f8fafc;--panel:#ffffff;--ink:#0f172a;--ink-dim:#475569;--accent:#2563eb;--card:#ffffff;
  --border:#e2e8f0; --thead:#e2e8f0; --btn-ink:#ffffff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Pretendard,system-ui,Segoe UI,Roboto,sans-serif}
header{padding:16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:5}
h1{font-size:20px;margin:0}
.caption{color:var(--ink-dim);font-size:13px}
.top-right{position:absolute;top:12px;right:16px;display:flex;gap:8px;align-items:center}
.badge{color:var(--ink-dim);font-size:12px}
main{max-width:1100px;margin:0 auto;padding:20px 16px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;min-width:160px}
.card .k{color:var(--ink-dim);font-size:12px}
.card .v{font-size:24px;font-weight:700;margin-top:4px}
.btn{all:unset;display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:var(--btn-ink);font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn.secondary{background:transparent;color:var(--ink);border:1px solid var(--border)}
input[type="text"]{flex:1;min-width:260px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--ink)}
textarea{width:100%;min-height:160px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--ink);padding:10px 12px}
.codebox{position:relative;background:transparent;border:1px dashed var(--border);border-radius:10px;padding:10px;overflow:auto}

.grid{overflow:auto;border:1px solid var(--border);border-radius:12px; background: var(--card);}
.grid-sets { max-height: 300px; }
.grid-issues { max-height: 600px; }

table{width:100%;border-collapse:collapse;font-size:14px;min-width:720px}
th,td{padding:8px 12px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap;line-height:var(--rowh)}
thead th{position:sticky;top:0;background:var(--thead);color:var(--ink);z-index:1}
footer{padding:12px 16px;color:var(--ink-dim);border-top:1px solid var(--border);text-align:right}

.sound-rule-panel { background: rgba(96, 165, 250, 0.1); border: 2px solid var(--accent); }
.sound-rule-title { font-size: 16px; font-weight: 800; color: var(--accent); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
.sound-tag-container { display: flex; gap: 8px; flex-wrap: wrap; }
.sound-tag { background: var(--accent); color: var(--btn-ink); padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 14px; }
.ps-hint { font-size: 12px; color: var(--ink-dim); background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; margin-top: 8px; }

.tr-error { background: rgba(239, 68, 68, 0.05); }
/* ì²´í¬ëœ ì´ìŠˆ ìŠ¤íƒ€ì¼ë§ */
.tr-checked { opacity: 0.4; text-decoration: line-through; background: transparent !important; }
input[type="checkbox"] { cursor: pointer; width: 16px; height: 16px; }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;justify-content:space-between;position:relative">
    <div>
      <h1>Yí´ë¼ìš°ë“œ ë¬¸ì œì€í–‰ íŒŒì¼ ê²€ì‚¬ê¸° (ì›¹ë²„ì „)</h1>
      <div class="caption">HWP/HWPX ì „ìš© Â· ì‚¬ìš´ë“œ MP3 Â· íŒŒì¼ëª… â€œë¶™ì—¬ë„£ê¸°â€ ê²€ì‚¬</div>
    </div>
    <div class="top-right">
      <button id="btn-reset" class="btn secondary">ë‹¤ì‹œí•˜ê¸°</button>
      <button id="btn-theme" class="btn secondary">ë‹¤í¬ â†” ë¼ì´íŠ¸</button>
      <span class="badge">â“’ Jeongyeon. 2026</span>
    </div>
  </div>
</header>

<main>
  <section class="panel">
    <h3 style="margin:0 0 8px">1) ìƒìœ„ í´ë” ê²½ë¡œ ì…ë ¥ â†’ PowerShell ëª…ë ¹ ë§Œë“¤ê¸°</h3>
    <div class="field">
      <input id="path-input" type="text" placeholder='ì˜ˆ) C:\Users\ì •ì—°\Documents\ë¬¸ì œì€í–‰' />
      <button id="btn-build" class="btn">ëª…ë ¹ ìƒì„±</button>
      <button id="btn-copy" class="btn secondary">ë³µì‚¬</button>
    </div>
    <div class="codebox" style="margin-top:10px">
      <pre id="ps-cmd" style="margin:0;white-space:pre-wrap"># ìƒë‹¨ì—ì„œ 'ëª…ë ¹ ìƒì„±'ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</pre>
    </div>
  </section>

  <section class="panel">
    <h3 style="margin:0 0 8px">2) PowerShell ì‹¤í–‰ í›„, ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°</h3>
    <div class="ps-hint">
        ğŸ’¡ <strong>PowerShell ë¹¨ë¦¬ ì—¬ëŠ” ë²•:</strong> <code>Win + R</code> í‚¤ ëˆ„ë¥´ê³  <code>powershell</code> ì…ë ¥ í›„ ì—”í„°!
    </div>
    <div class="field" style="margin:12px 0 8px">
      <button id="btn-paste" class="btn secondary">í´ë¦½ë³´ë“œì—ì„œ ë¶™ì—¬ë„£ê¸°</button>
    </div>
    <textarea id="paste-area" placeholder="ì—¬ê¸°ì— íŒŒì¼ëª… ëª©ë¡ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="btn-run" class="btn">ê²€ì‚¬ ì‹œì‘ ğŸš€</button>
      <button id="btn-dl-issues" class="btn secondary" disabled>ì´ìŠˆ CSV ë‹¤ìš´ë¡œë“œ</button>
      <button id="btn-dl-sets" class="btn secondary" disabled>ì„¸íŠ¸ ìš”ì•½ CSV ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </section>

  <section class="row" style="margin-bottom:8px">
    <div class="card"><div class="k">ì´ íŒŒì¼</div><div class="v" id="m-total-files">-</div></div>
    <div class="card"><div class="k">ì´ ì„¸íŠ¸</div><div class="v" id="m-total-sets">-</div></div>
    <div class="card"><div class="k">ì´ìŠˆ ìˆ˜</div><div class="v" id="m-total-issues">-</div></div>
  </section>

  <section class="panel sound-rule-panel">
    <div class="sound-rule-title">ğŸ”Š ì‚¬ìš´ë“œ íŒŒì¼(M) í•„ìˆ˜ í¬í•¨ Skill ì½”ë“œ</div>
    <div class="sound-tag-container">
        <span class="sound-tag">yyyy</span><span class="sound-tag">yyyn</span><span class="sound-tag">yyny</span><span class="sound-tag">yynn</span>
        <span class="sound-tag">ynyy</span><span class="sound-tag">ynyn</span><span class="sound-tag">ynny</span><span class="sound-tag">ynnn</span>
        <span class="sound-tag">nynn</span>
    </div>
    <p style="font-size: 13px; margin: 12px 0 0 0; color: var(--ink-dim);">* ìœ„ ì½”ë“œê°€ íŒŒì¼ëª… ëì— í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ë°˜ë“œì‹œ ì‚¬ìš´ë“œ íŒŒì¼ì´ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.</p>
  </section>

  <section class="panel">
    <h3 style="margin:0 0 10px">ğŸ§© ì„¸íŠ¸ ìš”ì•½ (ë¬¸ì œ ìˆëŠ” í•­ëª© ìš°ì„ )</h3>
    <div class="grid grid-sets"><table id="tbl-sets">
      <thead><tr><th>ì„¸íŠ¸ í‚¤</th><th>Qê°œìˆ˜</th><th>Aê°œìˆ˜</th><th>Mê°œìˆ˜</th><th>Gê·¸ë£¹</th><th>ë“£/ë§</th><th>ìƒíƒœ</th></tr></thead>
      <tbody></tbody>
    </table></div>
  </section>

  <section class="panel">
    <h3 style="margin:0 0 10px">âš ï¸ ì´ìŠˆ ìƒì„¸ (ìˆ˜ì • í›„ ì²´í¬í•˜ì„¸ìš”)</h3>
    <div class="grid grid-issues"><table id="tbl-issues">
      <thead><tr>
        <th style="width:40px">í™•ì¸</th>
        <th style="width:40px">#</th>
        <th>ì„¸íŠ¸ í‚¤(+ì½”ë“œ)</th>
        <th>ë¶„ë¥˜</th>
        <th>ìƒì„¸</th>
      </tr></thead>
      <tbody></tbody>
    </table></div>
  </section>
</main>

<footer>ëª¨ë“  ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</footer>

<script>
const VALID_QA = new Set(['.hwp','.hwpx']);
const VALID_M  = new Set(['.mp3','.wav']);
const LEADING_RE = /^(\d{6}_\d{4})([QAM])(.*)$/i;
const G_RE       = /_G(\d{2})(?:_|\.|$)/i;
const SKILL_RE   = /_([yn]{4})(?:_|\.|$)/i;

const SOUND_REQUIRED_LIST = new Set(['yyyy','yyyn','yyny','yynn','ynyy','ynyn','ynny','ynnn','nynn']);
const isSoundRequired = (skill) => skill && SOUND_REQUIRED_LIST.has(skill.toLowerCase());

const root = document.documentElement;
document.getElementById('btn-theme').addEventListener('click', () => {
  const next = (root.getAttribute('data-theme') || 'dark') === 'dark' ? 'light' : 'dark';
  root.setAttribute('data-theme', next);
  localStorage.setItem('ycloud_theme', next);
});

document.getElementById('btn-build').addEventListener('click', () => {
  const raw = (document.getElementById('path-input').value || '').trim();
  const P = raw.replaceAll('/', '\\') || 'C:\\ì‘ì—…\\ê²½ë¡œ';
  document.getElementById('ps-cmd').textContent = `$P="${P}";
$t=Get-ChildItem -LiteralPath "$P\\quest","$P\\answer","$P\\sound" -Recurse -File -ErrorAction SilentlyContinue;
if(-not $t){ $t=Get-ChildItem -LiteralPath $P -Recurse -File }
$names = $t | Select-Object -ExpandProperty Name
try { $names | Set-Clipboard } catch { ($names -join "\`r\`n") | clip }
"í´ë¦½ë³´ë“œì— $($names.Count)ê°œ íŒŒì¼ëª…ì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤."`;
});

document.getElementById('btn-copy').addEventListener('click', async () => {
  const cmdText = document.getElementById('ps-cmd').textContent;
  if(cmdText.startsWith('#')) return;
  await navigator.clipboard.writeText(cmdText);
  document.getElementById('btn-copy').textContent = "ë³µì‚¬ë¨!";
  setTimeout(()=>document.getElementById('btn-copy').textContent="ë³µì‚¬",1200);
});

document.getElementById('btn-paste').addEventListener('click', async () => {
  try { document.getElementById('paste-area').value = await navigator.clipboard.readText(); }
  catch(e){ alert('í´ë¦½ë³´ë“œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.'); }
});

document.getElementById('btn-reset').addEventListener('click', () => {
  document.getElementById('path-input').value = '';
  document.getElementById('paste-area').value = '';
  document.getElementById('ps-cmd').textContent = "# ìƒë‹¨ì—ì„œ 'ëª…ë ¹ ìƒì„±'ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.";
  document.getElementById('m-total-files').innerText = '-';
  document.getElementById('m-total-sets').innerText = '-';
  document.getElementById('m-total-issues').innerText = '-';
  document.querySelector('#tbl-sets tbody').innerHTML = '';
  document.querySelector('#tbl-issues tbody').innerHTML = '';
  document.getElementById('btn-dl-issues').disabled = true;
  document.getElementById('btn-dl-sets').disabled = true;
});

function renderTable(id, rows, cols, isIssueTable = false) {
  const tbody = document.querySelector(`#${id} tbody`);
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    
    if(!isIssueTable && r.status && r.status !== 'OK') tr.className = 'tr-error';

    // ì´ìŠˆ ìƒì„¸ í…Œì´ë¸”ì´ë©´ ì²´í¬ë°•ìŠ¤ ë¨¼ì € ì¶”ê°€
    if(isIssueTable) {
      const tdCheck = document.createElement('td');
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.addEventListener('change', () => {
        if(chk.checked) tr.classList.add('tr-checked');
        else tr.classList.remove('tr-checked');
      });
      tdCheck.appendChild(chk);
      tr.appendChild(tdCheck);
    }

    cols.forEach(c => {
      const td = document.createElement('td');
      td.textContent = r[c] ?? '';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function scanFromLines(lines) {
  const names = Array.from(new Set(lines.filter(Boolean)));
  const sets = new Map(), parsed = new Map(), issues = [];

  names.forEach(base => {
    const m = base.match(LEADING_RE);
    if (!m) return;
    const prefix = m[1], qa = m[2].toUpperCase(), tail = m[3];
    const g = (G_RE.exec(tail) || [])[1] || null;
    const skill = (SKILL_RE.exec(base) || [])[1]?.toLowerCase() || null;
    const baseNoExt = base.replace(/\.[^.]+$/,'');
    const setKey = `${prefix}_${baseNoExt.slice((prefix + qa).length).replace(/^_/,'').replace(/_([yn]{4})$/i,'').replace(/_$/,'')}`;
    
    if (!sets.has(setKey)) sets.set(setKey, {Q:new Set(), A:new Set(), M:new Set(), skills:new Set(), gnums:new Set(), files:new Set()});
    const d = sets.get(setKey);
    d[qa].add(base); d.files.add(base);
    if (skill) d.skills.add(skill);
    if (g) d.gnums.add(g);
    parsed.set(base, { qa, gnum: g, skill });
  });

  let setRows = [];
  sets.forEach((d, sk) => {
    const status = new Set();
    const skillsArr = [...d.skills].sort();
    const listen = skillsArr.some(s => isSoundRequired(s));
    const issueKey = skillsArr.length > 0 ? `${sk}_${skillsArr.length > 1 ? '('+skillsArr.join('|')+')' : skillsArr[0]}` : sk;

    if (d.gnums.size === 0) {
      let missing = [];
      if (d.Q.size === 0) missing.push('Q');
      if (d.A.size === 0) missing.push('A');
      if (listen && d.M.size === 0) missing.push('M(ì‚¬ìš´ë“œ)');
      if (missing.length > 0) {
        issues.push({set_key: issueKey, category: 'íŒŒì¼ êµ¬ì„± ë¯¸ë¹„', detail: `${missing.join('/')} ëˆ„ë½`});
        status.add(`${missing.join('/')} ëˆ„ë½`);
      }
    } else {
      const byG = new Map();
      d.files.forEach(f => {
        const p = parsed.get(f); if(!p.gnum) return;
        if(!byG.has(p.gnum)) byG.set(p.gnum, {Q:0, A:0, M:0, skills:new Set()});
        const gInfo = byG.get(p.gnum);
        gInfo[p.qa]++; if(p.skill) gInfo.skills.add(p.skill);
      });
      byG.forEach((comp, g) => {
        let gMissing = [];
        const gListen = [...comp.skills].some(s => isSoundRequired(s));
        if (g === '00') {
          if (comp.A > 0) { issues.push({set_key:`${sk}_G${g}`, category:'ê·œì¹™ ìœ„ë°˜', detail:'G00ì— A ì¡´ì¬'}); status.add('G00 ì˜¤ë¥˜'); }
          if (gListen && comp.M === 0) gMissing.push('M');
        } else {
          if (comp.Q === 0) gMissing.push('Q');
          if (comp.A === 0) gMissing.push('A');
          if (gListen && comp.M === 0) gMissing.push('M');
        }
        if (gMissing.length > 0) {
          issues.push({set_key: `${sk}_G${g}`, category: 'íŒŒì¼ êµ¬ì„± ë¯¸ë¹„', detail: `G${g}:${gMissing.join('/')} ëˆ„ë½`});
          status.add(`G${g} ëˆ„ë½`);
        }
      });
    }

    setRows.push({
      set_key_display: issueKey,
      q_count: d.Q.size, a_count: d.A.size, m_count: d.M.size,
      g_groups: [...d.gnums].sort().join(','),
      listen_speak: listen ? 'Y' : 'N',
      status: status.size ? [...status].join('; ') : 'OK'
    });
  });

  setRows.sort((a, b) => {
    if (a.status !== 'OK' && b.status === 'OK') return -1;
    if (a.status === 'OK' && b.status !== 'OK') return 1;
    return 0;
  });

  return { summary: { total_files: names.length, total_sets: sets.size }, sets: setRows, issues };
}

document.getElementById('btn-run').addEventListener('click', () => {
  const lines = document.getElementById('paste-area').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(lines.length === 0) return alert('ê²€ì‚¬í•  íŒŒì¼ëª…ì´ ì—†ìŠµë‹ˆë‹¤.');
  const res = scanFromLines(lines);
  document.getElementById('m-total-files').innerText = res.summary.total_files;
  document.getElementById('m-total-sets').innerText = res.summary.total_sets;
  document.getElementById('m-total-issues').innerText = res.issues.length;
  
  renderTable('tbl-sets', res.sets, ['set_key_display','q_count','a_count','m_count','g_groups','listen_speak','status']);
  renderTable('tbl-issues', res.issues.map((it, i) => ({ '#': i+1, ...it })), ['#','set_key','category','detail'], true);
  
  document.getElementById('btn-dl-issues').disabled = false;
  document.getElementById('btn-dl-sets').disabled = false;
  document.getElementById('btn-dl-issues').onclick = () => {
    const csv = '\ufeffì„¸íŠ¸ í‚¤,ë¶„ë¥˜,ìƒì„¸\n' + res.issues.map(i => `"${i.set_key}","${i.category}","${i.detail}"`).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'issues.csv'; a.click();
  };
});
</script>
</body>
</html>
