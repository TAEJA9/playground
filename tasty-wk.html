<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìš°ê²¸ ì „ìš© ë§›ì§‘ ë²„í‚·ë¦¬ìŠ¤íŠ¸</title></title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{ --ink:#0a0a0a; }
  html,body{ height:100%; }
  body{ font-family:Pretendard,-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif; background:linear-gradient(135deg,#fffaf0,#fff5f7,#f0f9ff); color:var(--ink); }
  .spring-in{ animation:spring-in .35s cubic-bezier(.2,.65,.25,1) both; }
  @keyframes spring-in{0%{transform:translateY(8px) scale(.96);opacity:0}60%{transform:translateY(-2px) scale(1.03);opacity:1}100%{transform:none;opacity:1}}
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(3px);opacity:0;visibility:hidden;transition:.2s;z-index:50}
  .modal.show{opacity:1;visibility:visible}
  .box{background:#fff;padding:1rem 1.25rem;border-radius:1rem;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.2)}
  .hearts{ position:fixed; inset:0; pointer-events:none; z-index:60; overflow:hidden; }
  .heart{ position:absolute; font-size:18px; filter:drop-shadow(0 3px 8px rgba(255,0,122,.25)); animation:float 1.1s ease-out forwards; }
  @keyframes float{ 0%{transform:translate(-50%,0) scale(.9);opacity:.95} 70%{transform:translate(-50%,-70px) scale(1.1);opacity:.85} 100%{transform:translate(-50%,-110px) scale(1.05);opacity:0} }
  #boardWrap{ max-height:420px; overflow-y:auto; border:1px solid rgba(24,24,27,.12); border-radius:1rem; }
  #boardWrap::-webkit-scrollbar{ width:8px } #boardWrap::-webkit-scrollbar-thumb{ background:rgba(0,0,0,.15); border-radius:6px }
</style>
</head>
<body class="p-4 sm:p-6">

<!-- í•˜íŠ¸ ë ˆì´ì–´ -->
<div id="hearts" class="hearts"></div>

<!-- ë¡œë”© ëª¨ë‹¬ -->
<div id="loading" class="modal"><div class="box">
  <div id="loadingEmojis" class="text-3xl mb-1">ğŸœğŸ›ğŸ£ğŸ•ğŸ”</div>
  <p class="font-semibold text-zinc-700">Loading...</p>
</div></div>

<main class="max-w-6xl mx-auto space-y-6">
  <!-- í—¤ë” -->
  <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
    <div>
      <h1 class="text-2xl sm:text-3xl font-extrabold">ìš°ê²¸ ì „ìš© ë§›ì§‘ ì¶”ì²œ ë²„í‚· ë¦¬ìŠ¤íŠ¸</h1>
      <p class="text-sm text-zinc-600">í•˜ë£¨ì— ë‘ ë¼ì”© ë¿Œì…”ë„ ë°˜ í‰ìƒ! </p>
    </div>
    <div id="today" class="text-xs bg-white/70 border border-white/60 px-2 py-1 rounded-full"></div>
  </header>

  <!-- ì˜¤ëŠ˜ì˜ ì„ íƒ -->
  <section class="bg-white/90 rounded-3xl shadow p-6">
    <p class="text-sm text-zinc-500">ì˜¤ëŠ˜ì˜ ì„ íƒ</p>
    <h2 id="result" class="text-4xl sm:text-5xl lg:text-6xl font-black mt-1 mb-2 min-h-[3.6rem]">
      ëœë¤ ì¶”ì²œ í´ë¦­!
    </h2>
    <div class="mt-2 flex flex-col sm:flex-row gap-2 max-w-md">
      <button id="random" class="flex-1 py-3 rounded-2xl bg-gradient-to-r from-pink-400 to-amber-400 text-white font-semibold shadow">ğŸ² ëœë¤ ì¶”ì²œ</button>
      <button id="like"   class="flex-1 py-3 rounded-2xl border border-zinc-300 bg-white hover:bg-zinc-50 font-semibold">ğŸ‘ ì¢‹ì•„ìš”</button>
    </div>
  </section>

  <!-- ë¦¬ë”ë³´ë“œ(ë„“ê²Œ) + ì¶”ê°€(ë” ë„“ê²Œ) -->
  <section class="grid grid-cols-1 lg:grid-cols-[1.6fr_1.4fr] gap-5">
    <!-- ë¦¬ë”ë³´ë“œ -->
    <div class="bg-white/90 rounded-3xl shadow p-6">
      <div class="mb-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <h3 class="text-lg font-bold">ğŸ”¥ ì¸ê¸° ë¦¬ë”ë³´ë“œ</h3>
        <!-- ì§€ì—­ í•„í„°ë¥¼ ë¦¬ë”ë³´ë“œ ìƒë‹¨ ìš°ì¸¡ìœ¼ë¡œ ì´ë™ -->
        <div class="flex items-center gap-2">
          <label for="regionFilter" class="text-sm text-zinc-600">ì§€ì—­ ë³´ê¸°:</label>
          <select id="regionFilter" class="px-3 py-2 border rounded-xl text-sm bg-white">
            <option value="__ALL__">ì „ì²´</option>
          </select>
        </div>
      </div>
      <div id="boardWrap">
        <table class="w-full text-sm border-collapse">
          <thead class="sticky top-0 bg-zinc-50 border-b border-zinc-200">
            <tr>
              <th class="text-left px-3 py-2 whitespace-nowrap">ìˆœìœ„</th>
              <th class="text-left px-3 py-2 whitespace-nowrap">ê°€ê²Œ</th>
              <th class="text-left px-3 py-2 whitespace-nowrap">ì§€ì—­</th>
              <th class="text-left px-3 py-2 whitespace-nowrap">ë©”ë‰´</th>
              <th class="text-right px-3 py-2 whitespace-nowrap">ì¢‹ì•„ìš”</th>
            </tr>
          </thead>
          <tbody id="board" class="divide-y divide-zinc-100"></tbody>
        </table>
      </div>
    </div>

    <!-- ê°€ê²Œ ì¶”ê°€ (PCì—ì„œ ë” ë„“ê²Œ) -->
    <div class="bg-white/90 rounded-3xl shadow p-6">
      <div class="flex items-center justify-between">
        <h4 class="font-bold text-lg">ğŸ± ê°€ê²Œ ì¶”ê°€í•˜ê¸°</h4>
        <span class="text-[11px] text-zinc-500">ì¶”ê°€ ì‹œ í•˜íŠ¸ ë¿…ğŸ’–</span>
      </div>

      <!-- xs: ìë™ 2í–‰ / sm ì´ìƒ: ë„“ì€ í•œ ì¤„ -->
      <div class="mt-3 grid grid-cols-1 sm:grid-cols-[1fr_1.4fr_1fr_auto] gap-2 items-stretch">
        <input id="region" class="px-3 py-2 border rounded-xl text-sm min-w-0" placeholder="ì§€ì—­ (ì˜ˆ: ì¶˜ì²œ)" />
        <input id="name"   class="px-3 py-2 border rounded-xl text-sm min-w-0" placeholder="ê°€ê²Œ ì´ë¦„ (ì˜ˆ: ìœ í¬ë¦¬ë§‰êµ­ìˆ˜)" />
        <input id="menu"   class="px-3 py-2 border rounded-xl text-sm min-w-0" placeholder="ë©”ë‰´ (ì˜ˆ: ë§‰êµ­ìˆ˜)" />
        <button id="add"   class="px-4 py-2 rounded-xl bg-zinc-900 text-white text-sm w-full sm:w-auto">ì¶”ê°€</button>
      </div>

      <button id="wipeBtn" class="mt-3 w-full py-2 border rounded-xl text-sm">ğŸ§¨ ê´€ë¦¬ì ì´ˆê¸°í™”</button>
    </div>
  </section>

  <footer class="text-center text-xs text-zinc-500">â“’ Jeongyeon. 2025</footer>
</main>

<script>
/* ===== ì„¤ì • ===== */
const WEB_APP_URL   = "https://script.google.com/macros/s/AKfycbwo41EHNnTgAQFs_fKgNq6-M3u0wzQbW1hkuZMps__RR2z326o5dmS56TuAjt0gWv5UnQ/exec"; // /exec
const ADMIN_PASSWORD= "24003";

/* ===== ìƒíƒœ ===== */
let places=[], votes={}, current=null, regionFilter="__ALL__";
let toggled = JSON.parse(sessionStorage.getItem("like_toggle") || "{}");

/* ===== ì—˜ë¦¬ë¨¼íŠ¸ ===== */
const $ = s=>document.querySelector(s);
const $board=$("#board"), $result=$("#result");
const $loading=$("#loading"), $loadingEmojis=$("#loadingEmojis");
const $name=$("#name"), $region=$("#region"), $menu=$("#menu");
const $add=$("#add"), $random=$("#random"), $like=$("#like"), $wipe=$("#wipeBtn");
const $hearts=$("#hearts"), $regionFilter=$("#regionFilter");

/* ===== ìœ í‹¸ ===== */
const EMOJIS=["ğŸ•","ğŸ”","ğŸ£","ğŸ›","ğŸœ","ğŸ¥Ÿ","ğŸŒ®","ğŸ","ğŸ±","ğŸ—"];
function showLoading(msg="Loading..."){ $loadingEmojis.textContent=Array.from({length:5},()=>EMOJIS[Math.floor(Math.random()*EMOJIS.length)]).join(""); $loading.querySelector("p").textContent=msg; $loading.classList.add("show"); }
function hideLoading(){ $loading.classList.remove("show"); }
const enc=v=>encodeURIComponent(v);
const api=(fn,params={})=>fetch(`${WEB_APP_URL}?fn=${fn}&${Object.entries(params).map(([k,v])=>`${k}=${enc(v)}`).join("&")}&_=${Date.now()}`,{cache:"no-store"}).then(r=>r.json());

/* í•˜íŠ¸ */
function popHearts(x,y,count=8){
  const hearts=["ğŸ’–","ğŸ’˜","ğŸ’—","ğŸ’“","ğŸ’","ğŸ’"];
  for(let i=0;i<count;i++){
    const s=document.createElement("span");
    s.className="heart";
    s.textContent=hearts[Math.floor(Math.random()*hearts.length)];
    s.style.left=`${x + (Math.random()*60-30)}px`;
    s.style.top =`${y + (Math.random()*20-10)}px`;
    s.style.fontSize=`${16+Math.random()*12}px`;
    s.style.animationDuration=`${0.9+Math.random()*0.5}s`;
    document.getElementById("hearts").appendChild(s);
    s.addEventListener("animationend",()=>s.remove());
  }
}

/* í•„í„° & ë Œë” */
const uniqueRegions=()=>[...new Set(places.map(p=>p.region).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
const filteredPlaces=()=>regionFilter==="__ALL__" ? places : places.filter(p=>p.region===regionFilter);

function renderRegionFilter(){
  const regs=uniqueRegions(); const keep=regionFilter;
  $regionFilter.innerHTML=`<option value="__ALL__">ì „ì²´</option>` + regs.map(r=>`<option value="${r}">${r}</option>`).join("");
  $regionFilter.value = regs.includes(keep) ? keep : "__ALL__";
  regionFilter=$regionFilter.value;
}
function renderBoard(){
  const rows = filteredPlaces().map(p=>({...p,v:votes[p.name]||0})).sort((a,b)=>b.v-a.v);
  $board.innerHTML = rows.length
    ? rows.map((r,i)=>`<tr>
        <td class="px-3 py-2 whitespace-nowrap">${i+1}</td>
        <td class="px-3 py-2 whitespace-nowrap">${r.name}</td>
        <td class="px-3 py-2 whitespace-nowrap">${r.region||''}</td>
        <td class="px-3 py-2 whitespace-nowrap">${r.cat||''}</td>
        <td class="px-3 py-2 text-right whitespace-nowrap">${r.v}</td>
      </tr>`).join("")
    : `<tr><td colspan="5" class="text-center py-4 text-zinc-500">ì´ ì§€ì—­ì—” ì•„ì§ ê°€ê²Œê°€ ì—†ì–´ìš”. í•˜ë‚˜ ì¶”ê°€í•´ë³¼ê¹Œìš”?</td></tr>`;
}
function renderResult(p){
  if(!p){ $result.textContent="ëœë¤ ì¶”ì²œ í´ë¦­!"; return; }
  $result.textContent = `${p.name} ${EMOJIS[Math.floor(Math.random()*EMOJIS.length)]}`;
  $result.classList.remove("spring-in"); void $result.offsetWidth; $result.classList.add("spring-in");
}

/* ì•¡ì…˜ */
async function refresh(){
  showLoading("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");
  try{
    const s=await api("state");
    places=s.places||[]; votes=s.votes||{};
    renderRegionFilter(); renderBoard();
  } finally { hideLoading(); }
}
async function doRandom(){
  const pool=filteredPlaces();
  if(!pool.length){ renderResult(null); return; }
  current=pool[Math.floor(Math.random()*pool.length)];
  renderResult(current);
}
async function doLike(){
  if(!current) return;
  showLoading("ì¢‹ì•„ìš” ë°˜ì˜ ì¤‘â€¦");
  try{
    const was=!!toggled[current.name];
    const s=await api("vote",{name:current.name,delta:was?-1:1});
    votes=s.votes||{}; toggled[current.name]=!was;
    sessionStorage.setItem("like_toggle",JSON.stringify(toggled));
    renderBoard();
  } finally { hideLoading(); }
}
async function doAdd(){
  const n=($name.value||"").trim();
  const r=($region.value||"").trim();
  const m=($menu.value||"").trim();
  if(!n) return alert("ê°€ê²Œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");
  showLoading("ê°€ê²Œ ì¶”ê°€ ì¤‘â€¦");
  try{
    const s=await api("add",{name:n,region:r,cat:m});
    if(s.error){ alert("ì¶”ê°€ ì‹¤íŒ¨: "+s.error); return; }
    places=s.places||[]; votes=s.votes||{};
    $name.value=""; // ì§€ì—­/ë©”ë‰´ ìœ ì§€
    renderRegionFilter(); renderBoard();
    const rect=$add.getBoundingClientRect();
    popHearts(rect.left+rect.width/2, rect.top+window.scrollY);
  } finally { hideLoading(); }
}
async function doWipe(){
  const pw=prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if(pw!==ADMIN_PASSWORD){ alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
  showLoading("ì „ì²´ ë¹„ìš°ëŠ” ì¤‘â€¦");
  try{
    const s=await api("wipe");
    places=s.places||[]; votes=s.votes||{}; toggled={}; sessionStorage.setItem("like_toggle","{}");
    current=null; renderResult(null); renderRegionFilter(); renderBoard();
    alert("ì˜¤ëŠ˜ì˜ ì¶”ì²œì„ ëª¨ë‘ ë¹„ì› ìŠµë‹ˆë‹¤. (ê°€ê²Œ/ì¢‹ì•„ìš” ì „ë¶€ ì‚­ì œ)");
  } finally { hideLoading(); }
}

/* ì´ë²¤íŠ¸ */
document.getElementById("random").onclick=doRandom;
document.getElementById("like").onclick=doLike;
document.getElementById("add").onclick=doAdd;
document.getElementById("wipeBtn").onclick=doWipe;
document.getElementById("regionFilter").addEventListener("change",e=>{ regionFilter=e.target.value; renderBoard(); });

/* ë‚ ì§œ */
(function(){ const d=new Date(), w="ì¼ì›”í™”ìˆ˜ëª©ê¸ˆí† "[d.getDay()]; document.getElementById("today").textContent=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${w}ìš”ì¼`; })();

/* ì‹œì‘ */
refresh();
</script>
</body>
</html>

