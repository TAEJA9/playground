<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì´ë²¤íŠ¸ ë‹¹ì²¨ì ì¶”ì²¨ê¸°</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg: #fafafa; --card: #ffffff; --text: #111; --subtext:#666;
    --primary:#111; --accent:#2563eb; --border:#e5e7eb; --shadow: 0 10px 30px rgba(0,0,0,.06); --radius:16px;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0c0f; --card:#121418; --text:#e5e7eb; --subtext:#9aa2b1; --primary:#e5e7eb; --accent:#3b82f6; --border:#1f2430; --shadow: 0 10px 30px rgba(0,0,0,.4) }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
  header h1{font-size:22px;margin:0}
  header .badge{font-size:12px;color:var(--accent);background:color-mix(in oklab,var(--accent) 12%, transparent);padding:6px 10px;border-radius:999px;border:1px solid color-mix(in oklab,var(--accent) 35%, transparent)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin:14px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:880px){.row,.grid2{grid-template-columns:1fr}}
  label{font-size:14px;display:flex;flex-direction:column;gap:6px}
  input[type="text"],input[type="number"],.pill{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text)}
  .hint{color:var(--subtext);font-size:13px;margin-top:6px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
  .btn{background:var(--primary);color:var(--card)}
  .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .radio-row{display:flex;gap:18px;flex-wrap:wrap}
  .drop{border:2px dashed var(--border);border-radius:16px;padding:20px;text-align:center;transition:.2s background}
  .drop.drag{background:color-mix(in oklab,var(--accent) 10%, transparent)}
  .kicker{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--accent);font-weight:700;margin-bottom:6px}
  .log{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;font-size:13px;white-space:pre-wrap;background:color-mix(in oklab,var(--card) 60%, transparent);border-radius:12px;padding:12px;border:1px dashed var(--border)}
  footer{margin:18px 0 40px;text-align:right;color:var(--subtext);font-size:12px}
  .switch{display:flex;align-items:center;gap:8px}
  .switch input{width:18px;height:18px}
  .pill{display:flex;align-items:center;gap:8px;justify-content:center}
  .pill input[type="file"]{display:none}
  .pill .fake{display:inline-flex;gap:8px;align-items:center}
</style>
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- seedrandom -->
<script src="https://cdn.jsdelivr.net/npm/seedrandom@3.0.5/seedrandom.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="kicker">Event Winners</div>
        <h1>ë‹¹ì²¨ì ì¶”ì²¨ê¸° Â· ë¡œì»¬ ì›¹</h1>
      </div>
      <div class="badge">Client-only Â· Privacy-safe</div>
    </header>

    <!-- ì—…ë¡œë“œ -->
    <section class="card">
      <div class="kicker">Upload</div>
      <div class="grid2">
        <div>
          <div id="drop" class="drop">
            <strong>ì—‘ì…€ íŒŒì¼ ë“œë˜ê·¸&ë“œë¡­</strong><br/>
            <span class="hint">ë˜ëŠ” ì•„ë˜ì—ì„œ íŒŒì¼ ì„ íƒ</span>
          </div>
          <label style="margin-top:10px">
            <span>ì—‘ì…€ íŒŒì¼ ì„ íƒ</span>
            <span class="pill"><label class="fake btn secondary"><input type="file" id="fileInput" accept=".xlsx,.xls" />íŒŒì¼ ì„ íƒ</label></span>
          </label>
        </div>
        <div>
          <div class="switch">
            <input type="checkbox" id="headerless">
            <label for="headerless" style="margin:0">ì²« í–‰ì— ì—´ë¨¸ë¦¬ê¸€ ì—†ìŒ(ì´ë¦„, id, ì „í™”ë²ˆí˜¸ ìˆœ)</label>
          </div>
          <div class="hint">ê¸°ë³¸ì€ â€œí—¤ë” ìˆìŒâ€ì…ë‹ˆë‹¤. í—¤ë”ê°€ ì—†ì„ ë•Œë§Œ ì²´í¬í•˜ì„¸ìš”.</div>

          <div class="row" style="margin-top:12px">
            <label>ì „ì²´ ì°¸ì—¬ì ì‹œíŠ¸ëª…
              <input type="text" id="sheetJoined" value="joined_all" />
            </label>
            <label>ë‹¹í•´ ì´ë²¤íŠ¸ ì°¸ì—¬ì ì‹œíŠ¸ëª…
              <input type="text" id="sheetOnly" value="only_joined" />
            </label>
          </div>

          <label style="margin-top:12px">ëœë¤ ì‹œë“œ (0~10000)
            <input type="number" id="seed" min="0" max="10000" placeholder="ë¹„ìš°ë©´ ìë™ ëœë¤" />
          </label>
          <div class="hint">ğŸ’¡ ì‹œë“œê°’ì€ ì¶”ì²¨ ê²°ê³¼ë¥¼ ê³ ì •í•˜ê¸° ìœ„í•œ ìˆ«ìì…ë‹ˆë‹¤. ê°™ì€ ë°ì´í„° + ê°™ì€ ì‹œë“œ = ê°™ì€ ê²°ê³¼.</div>
        </div>
      </div>
    </section>

    <!-- ëª¨ë“œ -->
    <section class="card">
      <div class="kicker">Mode</div>
      <div class="radio-row">
        <label><input type="radio" name="mode" value="dual" checked> ì´ì¤‘ ì¶”ì²¨(ì¤‘ë³µ ê°€ëŠ¥)</label>
        <label><input type="radio" name="mode" value="single"> ë‹¨ì¼ ì¶”ì²¨(í•œ ì‹œíŠ¸ì—ì„œ Nëª…)</label>
      </div>

      <div id="dualConfig" style="margin-top:12px">
        <div class="row">
          <label>ì „ì²´ ì°¸ì—¬ì ì¶”ì²¨ ì¸ì› (A)
            <input type="number" id="nJoined" value="125" min="0" />
          </label>
          <label>ë‹¹í•´ ì´ë²¤íŠ¸ ìµœì¢… ì¸ì› (B)
            <input type="number" id="nTotalOther" value="1000" min="0" />
          </label>
        </div>
        <div class="row">
          <label>ë‘ ìƒí’ˆ ì¤‘ë³µ ì¸ì› (O)
            <input type="number" id="nOverlap" value="20" min="0" />
          </label>
          <div></div>
        </div>
      </div>

      <div id="singleConfig" style="display:none;margin-top:12px">
        <div class="row">
          <label>ì‹œíŠ¸ëª…
            <input type="text" id="sheetSingle" value="joined_all" />
          </label>
          <label>ì¶”ì²¨ ì¸ì›
            <input type="number" id="nSingle" value="100" min="1" />
          </label>
        </div>
      </div>

      <div class="toolbar" style="margin-top:14px">
        <button id="runBtn" class="btn">ì¶”ì²¨ ì‹¤í–‰</button>
        <button id="downloadBtn" class="btn secondary" disabled>ì›ë³¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
        <button id="downloadMaskedBtn" class="btn secondary" disabled>ë§ˆìŠ¤í‚¹ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
      </div>
      <div class="hint" style="margin-top:6px">ì›ë³¸ ê²°ê³¼ í™•ì¸ í›„ ê°œì¸ì •ë³´ê°€ í¬í•¨ëœ ë°°í¬ìš©ìœ¼ë¡œëŠ” â€œë§ˆìŠ¤í‚¹ ê²°ê³¼ ë‹¤ìš´ë¡œë“œâ€ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</div>
    </section>

    <!-- ë¡œê·¸ -->
    <section class="card">
      <div class="kicker">Log</div>
      <div id="log" class="log">ì¤€ë¹„ë¨.</div>
    </section>

    <footer>â“’ Jeongyeon. 2025</footer>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const logBox = $('#log');
  const fileInput = $('#fileInput');
  const drop = $('#drop');

  const headerless = $('#headerless');
  const sheetJoined = $('#sheetJoined');
  const sheetOnly = $('#sheetOnly');
  const seedInput = $('#seed');

  const runBtn = $('#runBtn');
  const downloadBtn = $('#downloadBtn');
  const downloadMaskedBtn = $('#downloadMaskedBtn');

  const modeRadios = document.getElementsByName('mode');
  const dualConfig = $('#dualConfig');
  const singleConfig = $('#singleConfig');

  const nJoined = $('#nJoined');
  const nTotalOther = $('#nTotalOther');
  const nOverlap = $('#nOverlap');

  const sheetSingle = $('#sheetSingle');
  const nSingle = $('#nSingle');

  let resultsWB = null;          // ì›ë³¸ ê²°ê³¼ ì›Œí¬ë¶
  let resultsWBMasked = null;    // ë§ˆìŠ¤í‚¹ ê²°ê³¼ ì›Œí¬ë¶

  function setLog(msg){ logBox.textContent = msg; }
  function addLog(msg){ logBox.textContent += (logBox.textContent? "\n":"") + msg; }

  // Drag & Drop
  ;['dragenter','dragover'].forEach(evt=>{
    drop.addEventListener(evt,(e)=>{ e.preventDefault(); drop.classList.add('drag'); });
  });
  ;['dragleave','drop'].forEach(evt=>{
    drop.addEventListener(evt,(e)=>{ e.preventDefault(); drop.classList.remove('drag'); });
  });
  drop.addEventListener('drop', (e)=>{
    const f = e.dataTransfer.files?.[0];
    if(f){ fileInput.files = e.dataTransfer.files; addLog(`íŒŒì¼ ì„ íƒ: ${f.name}`); }
  });

  // ëª¨ë“œ í† ê¸€
  [...modeRadios].forEach(r => r.addEventListener('change', ()=>{
    const mode = getMode();
    if(mode==='dual'){ dualConfig.style.display=''; singleConfig.style.display='none'; }
    else { dualConfig.style.display='none'; singleConfig.style.display=''; }
  }));
  function getMode(){ return [...modeRadios].find(r=>r.checked).value; }

  function resolveSeed(){
    let s = seedInput.value.trim();
    if(s === ''){
      const auto = Math.floor(Math.random()*10001);
      seedInput.value = String(auto);
      return auto;
    }
    const v = parseInt(s, 10);
    if(isNaN(v) || v<0 || v>10000) throw new Error('ì‹œë“œëŠ” 0~10000 ì •ìˆ˜ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
    return v;
  }

  // --- ë§ˆìŠ¤í‚¹ í•¨ìˆ˜ë“¤ ---
  function maskName(name){
    if(!name) return '';
    const s = String(name);
    if(s.length <= 1) return '*';
    if(s.length === 2) return s[0] + '*';
    return s[0] + '*' + s[s.length-1];
  }
  function maskId(id){
    if(!id) return '';
    const s = String(id);
    if(s.length <= 3) return '***';
    return s.slice(0, s.length-3) + '***';
  }
  function maskPhone(phone){
    if(!phone) return '';
    const s = String(phone);
    // ê¸°ëŒ€ í˜•ì‹: 010-1234-5678 â†’ ê°€ìš´ë°ë§Œ ****
    const m = s.match(/^(\d{2,3})-(\d{3,4})-(\d{4})$/);
    if(m){
      return `${m[1]}-****-${m[3]}`;
    }
    // í¬ë§·ì´ ë‹¤ë¥´ë©´ ì¤‘ê°„ ë¶€ë¶„ë§Œ ëŒ€ëµ ë§ˆìŠ¤í‚¹ (ì•ˆì „ë§)
    return s.replace(/\d(?=\d{4})/g, '*');
  }

  function toSheet(rows){
    const data = rows.map(r=>({ì´ë¦„:r.ì´ë¦„||'', id:r.id||'', ì „í™”ë²ˆí˜¸:r.ì „í™”ë²ˆí˜¸||''}));
    return XLSX.utils.json_to_sheet(data);
  }
  function toSheetMasked(rows){
    const data = rows.map(r=>({
      ì´ë¦„: maskName(r.ì´ë¦„||''),
      id: maskId(r.id||''),
      ì „í™”ë²ˆí˜¸: maskPhone(r.ì „í™”ë²ˆí˜¸||'')
    }));
    return XLSX.utils.json_to_sheet(data);
  }

  // ì—‘ì…€ ì‹œíŠ¸ ì½ê¸°
  function readSheet(ws, hasHeader){
    const rows = XLSX.utils.sheet_to_json(ws, {header: 1, raw:false, defval:''});
    const out = [];
    if(hasHeader){
      const header = (rows[0]||[]).map(s=>String(s||'').trim());
      const idxName = header.findIndex(h=>h==='ì´ë¦„' || /name/i.test(h));
      const idxId = header.findIndex(h=>h==='id' || /^ID$/i.test(h));
      const idxPhone = header.findIndex(h=>h==='ì „í™”ë²ˆí˜¸' || /phone|tel/i.test(h));
      if(idxName<0 || idxId<0 || idxPhone<0) throw new Error('í—¤ë”ê°€ ìˆëŠ” ê²½ìš°, ì»¬ëŸ¼ëª…ì€ ìµœì†Œ [ì´ë¦„, id, ì „í™”ë²ˆí˜¸]ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
      for(let i=1;i<rows.length;i++){
        const r = rows[i]||[];
        out.push({
          ì´ë¦„: String(r[idxName]||'').trim() || undefined,
          id: String(r[idxId]||'').trim() || undefined,
          ì „í™”ë²ˆí˜¸: String(r[idxPhone]||'').trim() || undefined,
        });
      }
    } else {
      for(const r of rows){
        if(!r) continue;
        out.push({
          ì´ë¦„: String((r[0]??'')).trim() || undefined,
          id: String((r[1]??'')).trim() || undefined,
          ì „í™”ë²ˆí˜¸: String((r[2]??'')).trim() || undefined,
        });
      }
    }
    return out;
  }

  function makeKey(o){
    if(o.id) return `id|${o.id}`;
    if(o.ì „í™”ë²ˆí˜¸) return `phone|${o.ì „í™”ë²ˆí˜¸}`;
    return `namecombo|${o.ì´ë¦„||''}|${o.ì „í™”ë²ˆí˜¸||''}`;
  }
  function uniqueByKey(arr){
    const seen = new Set(); const out=[];
    for(const o of arr){
      const k = makeKey(o);
      if(!seen.has(k)){ seen.add(k); out.push({...o, _key:k}); }
    }
    return out;
  }

  // í‘œë³¸ì¶”ì¶œ(ë¹„ê°€ì¤‘, ë¹„ë³µì›)
  function sampleKeys(keysArr, n, rng){
    if(n < 0) throw new Error('ì¶”ì²¨ ì¸ì›ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    if(keysArr.length < n) throw new Error(`ì¶”ì²¨ ì¸ì›ì´ ë°ì´í„°ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤. ë°ì´í„° ${keysArr.length} / ìš”ì²­ ${n}`);
    const a = keysArr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(rng()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a.slice(0,n);
  }
  function shuffleRows(rows, rng){
    const a = rows.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(rng()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  $('#runBtn').addEventListener('click', async ()=>{
    try{
      setLog('ì‹¤í–‰ ì¤‘â€¦');
      downloadBtn.disabled = true;
      downloadMaskedBtn.disabled = true;
      resultsWB = null; resultsWBMasked = null;

      if(!fileInput.files[0]) throw new Error('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
      const buf = await fileInput.files[0].arrayBuffer();
      const wb = XLSX.read(buf, {type:'array'});
      const hasHeader = !headerless.checked;

      const seed = resolveSeed();
      const rng = new Math.seedrandom(String(seed));

      // ê²°ê³¼ ì›Œí¬ë¶ 2ì¢…: ì›ë³¸, ë§ˆìŠ¤í‚¹
      resultsWB = XLSX.utils.book_new();
      resultsWBMasked = XLSX.utils.book_new();

      if(getMode()==='single'){
        const sname = sheetSingle.value.trim();
        const ws = wb.Sheets[sname];
        if(!ws) throw new Error(`ì‹œíŠ¸ ì—†ìŒ: ${sname}`);
        const arr = uniqueByKey(readSheet(ws, hasHeader));
        const n = parseInt(nSingle.value,10);
        const pick = sampleKeys(arr.map(r=>r._key), n, rng);
        const winners = shuffleRows(arr.filter(r=>pick.includes(r._key)), rng);

        XLSX.utils.book_append_sheet(resultsWB, toSheet(winners), 'winners_single');
        XLSX.utils.book_append_sheet(resultsWBMasked, toSheetMasked(winners), 'winners_single(masked)');

        setLog(`ë‹¨ì¼ ì¶”ì²¨ ì™„ë£Œ: ${winners.length}ëª…\nì‹œë“œ: ${seed}`);
      } else {
        const wsJ = wb.Sheets[sheetJoined.value.trim()];
        const wsO = wb.Sheets[sheetOnly.value.trim()];
        if(!wsJ) throw new Error(`ì‹œíŠ¸ ì—†ìŒ: ${sheetJoined.value}`);
        if(!wsO) throw new Error(`ì‹œíŠ¸ ì—†ìŒ: ${sheetOnly.value}`);

        const joinedArr = uniqueByKey(readSheet(wsJ, hasHeader));
        const onlyArr = uniqueByKey(readSheet(wsO, hasHeader));

        const joinedKeys = new Set(joinedArr.map(r=>r._key));
        const onlyKeysRaw = new Set(onlyArr.map(r=>r._key));
        const onlyKeys = [...onlyKeysRaw].filter(k=>!joinedKeys.has(k)); // ì •ì œ

        const A = parseInt(nJoined.value,10);
        const B = parseInt(nTotalOther.value,10);
        const O = parseInt(nOverlap.value,10);
        if(O > B) throw new Error('ì¤‘ë³µ ì¸ì›ì´ ìµœì¢… ì¸ì›ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        const needOnly = B - O;

        if(joinedKeys.size < A) throw new Error(`ì „ì²´ ì°¸ì—¬ì ë¶€ì¡±: ${joinedKeys.size} / í•„ìš” ${A}`);
        if(onlyKeys.length < needOnly) throw new Error(`ì •ì œëœ ë‹¹í•´ ì´ë²¤íŠ¸ ì°¸ì—¬ì ë¶€ì¡±: ${onlyKeys.length} / í•„ìš” ${needOnly}`);

        const joinedPick = sampleKeys([...joinedKeys], A, rng);
        const overlapPick = O>0 ? sampleKeys(joinedPick, O, rng) : [];
        const onlyPick = sampleKeys(onlyKeys, needOnly, rng);
        const finalOther = [...onlyPick, ...overlapPick];

        const actualOverlap = new Set(joinedPick.filter(k=>finalOther.includes(k)));
        if(actualOverlap.size !== O) throw new Error(`ì¤‘ë³µì ìˆ˜ ë¶ˆì¼ì¹˜: ${actualOverlap.size} / ëª©í‘œ ${O}`);

        const byKey = (arr)=> Object.fromEntries(arr.map(r=>[r._key, r]));
        const J = byKey(joinedArr);
        const OJ = byKey([...onlyArr, ...joinedArr]);

        const winnersA = shuffleRows(joinedPick.map(k=>J[k]), rng);
        const winnersB = shuffleRows(finalOther.map(k=>OJ[k]), rng);
        const overlaps = shuffleRows([...actualOverlap].map(k=>J[k]), rng);

        // ì›ë³¸
        XLSX.utils.book_append_sheet(resultsWB, toSheet(winnersA), 'winners_A(ì „ì²´ì°¸ì—¬)');
        XLSX.utils.book_append_sheet(resultsWB, toSheet(winnersB), 'winners_B(ë‹¹í•´ì´ë²¤íŠ¸)');
        if(O>0) XLSX.utils.book_append_sheet(resultsWB, toSheet(overlaps), 'overlaps(ì¤‘ë³µì)');

        // ë§ˆìŠ¤í‚¹
        XLSX.utils.book_append_sheet(resultsWBMasked, toSheetMasked(winnersA), 'winners_A(ì „ì²´ì°¸ì—¬_masked)');
        XLSX.utils.book_append_sheet(resultsWBMasked, toSheetMasked(winnersB), 'winners_B(ë‹¹í•´ì´ë²¤íŠ¸_masked)');
        if(O>0) XLSX.utils.book_append_sheet(resultsWBMasked, toSheetMasked(overlaps), 'overlaps(ì¤‘ë³µì_masked)');

        setLog(`ì´ì¤‘ ì¶”ì²¨ ì™„ë£Œ: A=${winnersA.length}ëª…, B=${winnersB.length}ëª… (ì¤‘ë³µ ${overlaps.length}ëª…)\nì‹œë“œ: ${seed}`);
      }

      downloadBtn.disabled = false;
      downloadMaskedBtn.disabled = false;
    }catch(err){
      resultsWB = null; resultsWBMasked = null;
      downloadBtn.disabled = true; downloadMaskedBtn.disabled = true;
      setLog('âŒ ì˜¤ë¥˜: ' + err.message);
      console.error(err);
    }
  });

  function tsName(prefix){
    const t = new Date(); const pad = n=>String(n).padStart(2,'0');
    return `${prefix}_${t.getFullYear()}${pad(t.getMonth()+1)}${pad(t.getDate())}_${pad(t.getHours())}${pad(t.getMinutes())}${pad(t.getSeconds())}.xlsx`;
  }

  $('#downloadBtn').addEventListener('click', ()=>{
    if(!resultsWB) return;
    XLSX.writeFile(resultsWB, tsName('winners'));
  });
  $('#downloadMaskedBtn').addEventListener('click', ()=>{
    if(!resultsWBMasked) return;
    XLSX.writeFile(resultsWBMasked, tsName('winners_masked'));
  });
})();
</script>
</body>
</html>
