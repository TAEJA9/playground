<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ´ ì˜¤ëŠ˜ ì ì‹¬, ì–´ë”” ê°€ì§€?</title>

  <!-- Pretendard -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --brand-1:#f97316; --brand-2:#ec4899; --ink:#0a0a0a; }
    html,body{ font-family:Pretendard,-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; }
    .card{ position:relative; overflow:hidden; }
    .card::before{
      content:""; position:absolute; inset:-40% -40% auto auto; width:180px; height:180px; border-radius:9999px;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.7), transparent 60%); filter:blur(8px); transform:rotate(20deg);
    }
    @keyframes spring-in{0%{transform:translateY(8px) scale(.98);opacity:0}60%{transform:translateY(-2px) scale(1.03);opacity:1}100%{transform:none}}
    .spring-in{animation:spring-in .32s cubic-bezier(.2,.65,.25,1) both}
    .brand-divider{height:3px;border-radius:9999px;background:linear-gradient(90deg,var(--brand-1),var(--brand-2))}
    @media (max-width: 768px){ .mobile-tight{ padding:14px !important; } }

    /* ë¡œë”© ëª¨ë‹¬ */
    #loadingModal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50; backdrop-filter:saturate(140%) blur(2px);}
    #loadingModal.show{ display:flex; }
    .loading-box{ background:white; border-radius:1rem; padding:1.25rem 1.5rem; box-shadow:0 8px 30px rgba(0,0,0,0.2); text-align:center; animation:popIn .22s ease-out; }
    @keyframes popIn{0%{transform:scale(.92);opacity:.5}100%{transform:scale(1);opacity:1}}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-rose-100 via-amber-100 to-sky-100 text-[var(--ink)]">
  <!-- ë¡œë”© ëª¨ë‹¬ -->
  <div id="loadingModal">
    <div class="loading-box">
      <div id="loadingEmojis" class="text-3xl mb-1">ğŸ•ğŸ”ğŸŸğŸ£ğŸœ</div>
      <p class="font-semibold text-zinc-700">Loading...</p>
    </div>
  </div>

  <main class="max-w-5xl mx-auto px-4 sm:px-6 pt-4 pb-10">
    <!-- í—¤ë” -->
    <section class="mb-4">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="flex items-center gap-2 sm:gap-3">
          <span class="text-2xl sm:text-3xl">ğŸ±</span>
          <div>
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold tracking-tight">ì˜¤ëŠ˜ ì ì‹¬ ë¨¹ìœ¼ëŸ¬ ì–´ë”” ê°€ì§€?</h1>
            <p class="text-xs sm:text-sm text-zinc-600">ê°€ê²Œë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”!</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="todayBadge" class="px-2.5 py-1 rounded-full text-xs bg-white/80 border border-white/60 shadow-sm"></span>
          <button id="adminResetBtn" class="px-2.5 py-1.5 rounded-xl border border-zinc-300 bg-white/80 hover:bg-white transition text-xs sm:text-sm">
            ğŸ§¨ ê´€ë¦¬ì ëª¨ë“œ
          </button>
        </div>
      </div>
      <div class="brand-divider mt-3"></div>
    </section>

    <!-- ë©”ì¸: ì˜¤ë¥¸ìª½ ì˜ì—­ì„ ë” ë„“ê²Œ -->
    <section class="grid grid-cols-1 md:grid-cols-[1fr_1.3fr] gap-4 md:gap-6">
      <!-- ì™¼ìª½ ì¹´ë“œ -->
      <div id="resultCard" class="card p-6 sm:p-7 bg-white/90 rounded-3xl shadow-xl border border-white/50 mobile-tight">
        <p class="text-xs sm:text-sm text-zinc-500">ì˜¤ëŠ˜ì˜ ì„ íƒ</p>
        <h2 id="resultText" class="mt-1 sm:mt-2 text-3xl sm:text-4xl md:text-5xl font-black leading-tight">ë­ ë¨¹ìœ¼ëŸ¬ ê°ˆë˜ìš”?</h2>
        <p class="mt-2 text-[11px] sm:text-xs text-zinc-500">ë¦¬ë”ë³´ë“œì— ìˆëŠ” ê°€ê²Œ ì¤‘ì—ì„œ ëœë¤ìœ¼ë¡œ ê³¨ë¼ë“œë ¤ìš”.</p>
        <div class="mt-5 flex flex-col sm:flex-row gap-2">
          <button id="randomAll" class="w-full sm:w-auto px-4 py-3 rounded-2xl bg-gradient-to-r from-amber-400 to-pink-400 text-white font-semibold shadow hover:opacity-95">ğŸ² ëœë¤ ì¶”ì²œ</button>
          <button id="likeBtn" class="w-full sm:w-auto px-4 py-3 rounded-2xl border border-zinc-200 bg-white hover:bg-zinc-50">ğŸ‘ ì¢‹ì•„ìš”</button>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: ë¦¬ë”ë³´ë“œ + ê°€ê²Œ ì¶”ê°€ -->
      <div class="p-6 sm:p-7 bg-white/90 rounded-3xl shadow-xl border border-white/50 mobile-tight">
        <h3 class="text-lg sm:text-xl font-bold mb-3">ğŸ”¥ ì¸ê¸° ê°€ê²Œ ë¦¬ë”ë³´ë“œ</h3>

        <div class="overflow-auto rounded-2xl border border-zinc-200 max-h-[260px] sm:max-h-[340px]">
          <table class="w-full text-xs sm:text-sm">
            <thead class="bg-zinc-50 sticky top-0">
              <tr><th class="px-3 sm:px-4 py-2 text-left">ìˆœìœ„</th><th class="px-3 sm:px-4 py-2 text-left">ê°€ê²Œ</th><th class="px-3 sm:px-4 py-2 text-right">ì¢‹ì•„ìš”</th></tr>
            </thead>
            <tbody id="leaderboard" class="bg-white"></tbody>
          </table>
        </div>

        <div class="mt-4 sm:mt-5">
          <h4 class="font-semibold mb-2">ê°€ê²Œ ì¶”ê°€</h4>

          <!-- â˜… í•œ ì¤„ ê³ ì •: sm ì´ìƒì—ì„œëŠ” flex-nowrap -->
          <div class="flex flex-col sm:flex-row sm:flex-nowrap gap-2 items-stretch">
            <input id="placeName" class="px-3 py-2 border rounded-xl text-sm flex-[2] min-w-0" placeholder="ì‹œê·¸ë‹ˆì²˜ íƒ€ì›Œ" />
            <input id="placeCat"  class="px-3 py-2 border rounded-xl text-sm flex-1 min-w-0" list="catsList" placeholder="ì¹´í…Œê³ ë¦¬(ì„ íƒ)" />
            <datalist id="catsList"></datalist>
            <button id="addPlaceBtn" class="px-4 py-2 rounded-xl bg-zinc-900 text-white text-sm shrink-0 whitespace-nowrap">ì¶”ê°€</button>
          </div>

          <p class="text-[11px] sm:text-xs text-zinc-500 mt-1">ì¹´í…Œê³ ë¦¬ëŠ” ë¹„ì›Œë„ ë©ë‹ˆë‹¤. ìƒˆ ì´ë¦„ì„ ì ìœ¼ë©´ ìƒˆ ì¹´í…Œê³ ë¦¬ë¡œ ì €ì¥ë¼ìš”.</p>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-center text-[11px] sm:text-xs text-zinc-500">
      â“’ Jeongyeon. 2025
    </footer>
  </main>

  <script>
    // ===== ì„¤ì • =====
    const WEB_APP_URL    = "https://script.google.com/macros/s/AKfycbyfLjdjQked5ZDMiQr219fW3BnsDBEaddK5aEviom9GQQT9fOwsKfRLkvdDwOgLiYtgzA/exec";
    const ADMIN_PASSWORD = "24003";

    // ===== ìƒíƒœ =====
    let places=[], votes={}, currentPick='';
    let toggled = JSON.parse(sessionStorage.getItem('lunch_like_toggle') || "{}");

    // ===== ì—˜ë¦¬ë¨¼íŠ¸ =====
    const $ = (s)=>document.querySelector(s);
    const resultText=$("#resultText"), likeBtn=$("#likeBtn"), randomAll=$("#randomAll"),
          leaderBody=$("#leaderboard"), addPlaceBtn=$("#addPlaceBtn"), placeName=$("#placeName"),
          placeCat=$("#placeCat"), catsList=$("#catsList"), adminResetBtn=$("#adminResetBtn"),
          todayBadge=$("#todayBadge"), modal=$("#loadingModal"), modalEmoji=$("#loadingEmojis");

    // â˜… ì´ëª¨ì§€ ëª©ë¡ì„ ë°°ì—´ë¡œ ëª…ì‹œ(ìœ ë‹ˆì½”ë“œ ì•ˆì „)
    const LOADING_EMOJIS = ["ğŸ•","ğŸ”","ğŸŸ","ğŸŒ­","ğŸ¿","ğŸ¥“","ğŸ¥š","ğŸ³","ğŸ§‡","ğŸ¥","ğŸ§ˆ","ğŸ","ğŸ¥","ğŸ¥¨","ğŸ¥¯","ğŸ¥–","ğŸ«“","ğŸ§€","ğŸ¥—","ğŸ¥™","ğŸ¥ª","ğŸŒ®","ğŸŒ¯","ğŸ«”","ğŸ¥«","ğŸ–","ğŸ—","ğŸ¥©","ğŸ ","ğŸ¥Ÿ","ğŸ¥ ","ğŸ¥¡","ğŸ±","ğŸ˜","ğŸ™","ğŸš","ğŸ›","ğŸœ","ğŸ¦ª","ğŸ£","ğŸ¤","ğŸ¥","ğŸ¥®","ğŸ¢","ğŸ§†","ğŸ¥˜","ğŸ²","ğŸ«•","ğŸ","ğŸ¥£","ğŸ¥§","ğŸ¦","ğŸ§","ğŸ¨","ğŸ©","ğŸ‚"];

    const qs=(p)=>Object.entries(p).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
    const saveToggle=()=>sessionStorage.setItem('lunch_like_toggle',JSON.stringify(toggled));
    const setLikeBtnLabel=()=>{ likeBtn.textContent = currentPick ? (toggled[currentPick] ? "ğŸ™…â€â™€ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ" : "ğŸ‘ ì¢‹ì•„ìš”") : "ğŸ‘ ì¢‹ì•„ìš”"; };

    function sampleEmojis(n=5){
      const arr=[...LOADING_EMOJIS];
      const pick=[];
      while(pick.length<n && arr.length){
        const i=Math.floor(Math.random()*arr.length);
        pick.push(arr.splice(i,1)[0]);
      }
      return pick.join('');
    }
    function showLoading(msg="Loading..."){
      modalEmoji.textContent = sampleEmojis(5);
      modal.querySelector("p").textContent = msg;
      modal.classList.add("show");
    }
    function hideLoading(){ modal.classList.remove("show"); }

    function formatTodayBadge(){
      const d=new Date(); const wd=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
      todayBadge.textContent = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${wd}ìš”ì¼`;
    }

    async function api(fn,params={}){ const url=WEB_APP_URL+"?"+qs({fn,...params}); const r=await fetch(url); return r.json(); }
    async function withLoading(msg,fn){ showLoading(msg); try{ return await fn(); } finally{ hideLoading(); } }

    async function refresh(){
      await withLoading("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦", async ()=>{
        const s=await api("state");
        places=s.places||[]; votes=s.votes||{};
        renderLeaderboard(); renderCats(); setLikeBtnLabel();
      });
    }

    function renderCats(){
      const cats=[...new Set(places.map(p=>p.cat).filter(Boolean))];
      catsList.innerHTML = cats.map(c=>`<option value="${c}">`).join("");
    }

    function renderLeaderboard(){
      const rows = places.map(p=>({n:p.name, v:votes[p.name]||0})).sort((a,b)=>b.v-a.v);
      leaderBody.innerHTML = rows.length
        ? rows.map((r,i)=>`<tr><td class="px-3 py-2">${i+1}</td><td class="px-3 py-2">${r.n}</td><td class="px-3 py-2 text-right font-semibold">${r.v}</td></tr>`).join("")
        : `<tr><td colspan="3" class="px-3 py-3 text-center text-zinc-500">ê°€ê²Œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</td></tr>`;
    }

    function renderResult(name){
      if(!name){ resultText.textContent="ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘!"; setLikeBtnLabel(); return; }
      const em=["ğŸœ","ğŸ›","ğŸ•","ğŸ¥—","ğŸ£","ğŸ—","ğŸ¥ª","ğŸŒ®","ğŸ”","ğŸ¥Ÿ","ğŸ"];
      resultText.textContent = `${name} ${em[Math.floor(Math.random()*em.length)]}`;
      resultText.classList.remove("spring-in"); void resultText.offsetWidth; resultText.classList.add("spring-in");
      setLikeBtnLabel();
    }

    async function doVoteToggle(){
      if(!currentPick) return;
      await withLoading("ì¢‹ì•„ìš” ë°˜ì˜ ì¤‘â€¦", async ()=>{
        const was=toggled[currentPick]; const delta=was?-1:+1;
        const s=await api("vote",{name:currentPick,delta});
        votes=s.votes||{}; toggled[currentPick]=!was; saveToggle(); renderLeaderboard(); setLikeBtnLabel();
      });
    }

    async function doAdd(){
      const n=placeName.value.trim(); const c=placeCat.value.trim();
      if(!n) return;
      await withLoading("ê°€ê²Œ ì¶”ê°€ ì¤‘â€¦", async ()=>{
        const s=await api("add",{name:n,cat:c});
        places=s.places||[]; votes=s.votes||{};
        placeName.value=""; renderLeaderboard(); renderCats(); currentPick=n; renderResult(n);
      });
    }

    async function doAdminWipe(){
      const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      if(pw!==ADMIN_PASSWORD){ alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
      await withLoading("ì „ì²´ ë¹„ìš°ëŠ” ì¤‘â€¦", async ()=>{
        const s=await api("wipe"); // â˜… í…Œì´ë¸” ë¹„ìš°ê¸°
        places=s.places||[]; votes=s.votes||{}; toggled={}; saveToggle();
        renderLeaderboard(); renderCats(); currentPick=""; renderResult("");
        alert("ì˜¤ëŠ˜ì˜ ì¶”ì²œì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ìˆœìœ„/ê°€ê²Œ/ì¢‹ì•„ìš” ì „ë¶€ ì´ˆê¸°í™”)");
      });
    }

    // ì´ë²¤íŠ¸
    randomAll.onclick = ()=>withLoading("ì¶”ì²œ ì¤‘â€¦", ()=>{
      const pool=places.map(p=>p.name); if(!pool.length){ currentPick=""; renderResult(""); return; }
      currentPick = pool[Math.floor(Math.random()*pool.length)];
      renderResult(currentPick);
    });
    likeBtn.onclick     = doVoteToggle;
    addPlaceBtn.onclick = doAdd;
    adminResetBtn.onclick = doAdminWipe;

    formatTodayBadge();
    refresh();
  </script>
</body>
</html>
