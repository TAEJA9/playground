<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ğŸ´ ë­ ë¨¹ìœ¼ëŸ¬ ê°ˆë˜ìš”?</title>

  <!-- Pretendard -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- QRCode Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root { --brand-1:#f97316; --brand-2:#ec4899; --ink:#0a0a0a; }
    html,body{ font-family:Pretendard,-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; }
    .brand-divider{height:3px;border-radius:9999px;background:linear-gradient(90deg,var(--brand-1),var(--brand-2))}
    .spring-in{animation:spring-in .32s cubic-bezier(.2,.65,.25,1) both}
    @keyframes spring-in{0%{transform:translateY(8px) scale(.98);opacity:0}60%{transform:translateY(-2px) scale(1.03);opacity:1}100%{transform:none}}
    @media (max-width: 768px){ .mobile-tight{ padding:14px !important; } }

    /* ëª¨ë‹¬ ê³µí†µ: í•­ìƒ flex ì¤‘ì•™ì •ë ¬, ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°ëŠ” opacity+visibilityë¡œ */
    .modal-backdrop{
      position:fixed; inset:0; z-index:50;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35); backdrop-filter:blur(2px);
      opacity:0; visibility:hidden; transition:opacity .18s ease, visibility .18s ease;
    }
    .modal-backdrop.show{ opacity:1; visibility:visible; }
    .modal-box{ background:white; border-radius:1rem; padding:1.25rem 1.5rem; box-shadow:0 8px 30px rgba(0,0,0,.2); text-align:center; }

    /* ì¹´ë“œ ì¥ì‹ */
    .card{ position:relative; overflow:hidden; }
    .card::before{
      content:""; position:absolute; inset:-40% -40% auto auto; width:180px; height:180px; border-radius:9999px;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.7), transparent 60%); filter:blur(8px); transform:rotate(20deg);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-rose-100 via-amber-100 to-sky-100 text-[var(--ink)]">
  <!-- ë¡œë”© ëª¨ë‹¬ -->
  <div id="loadingModal" class="modal-backdrop" aria-modal="true" role="dialog">
    <div class="modal-box">
      <div id="loadingEmojis" class="text-3xl mb-1">ğŸ•ğŸ”ğŸ£ğŸœ</div>
      <p class="font-semibold text-zinc-700">Loading...</p>
    </div>
  </div>

  <!-- QR ëª¨ë‹¬ -->
  <div id="qrModal" class="modal-backdrop" aria-modal="true" role="dialog">
    <div class="modal-box w-[min(92vw,360px)]">
      <h4 class="text-lg font-bold mb-1">ğŸ“± ì ì‹¬ ì¶”ì²œ QR</h4>
      <canvas id="qrCanvas" class="mx-auto block"></canvas>
      <p id="qrUrlText" class="text-xs text-zinc-600 mt-2 break-all"></p>
      <div class="mt-4">
        <button id="qrClose" class="px-4 py-2 rounded-xl border border-zinc-300 bg-white hover:bg-zinc-50 text-sm">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <main class="max-w-5xl mx-auto px-4 sm:px-6 pt-4 pb-10">
    <!-- í—¤ë” -->
    <section class="mb-4">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="flex items-center gap-2 sm:gap-3">
          <span class="text-2xl sm:text-3xl">ğŸ±</span>
          <div>
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold tracking-tight">ì˜¤ëŠ˜ ì ì‹¬, ì–´ë”” ê°€ì§€?</h1>
            <p class="text-xs sm:text-sm text-zinc-600">ì¢‹ì•„ìš” ìˆ˜ê°€ ê°€ì¥ ë§ì€ ê³³ìœ¼ë¡œ ê°€ê¸°ë¡œ í•´ìš”!</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="qrBtn" class="px-2.5 py-1.5 rounded-xl border border-zinc-300 bg-white/80 hover:bg-white text-xs sm:text-sm">ğŸ“· QR ì½”ë“œ</button>
          <span id="todayBadge" class="px-2.5 py-1 rounded-full text-xs bg-white/80 border border-white/60 shadow-sm"></span>
          <button id="adminResetBtn" class="px-2.5 py-1.5 rounded-xl border border-zinc-300 bg-white/80 hover:bg-white text-xs sm:text-sm">
            ğŸ§¨ ê´€ë¦¬ì ì´ˆê¸°í™”
          </button>
        </div>
      </div>
      <div class="brand-divider mt-3"></div>
    </section>

    <!-- ë©”ì¸: ì˜¤ë¥¸ìª½ ë„“ê²Œ -->
    <section class="grid grid-cols-1 md:grid-cols-[1fr_1.3fr] gap-4 md:gap-6">
      <!-- ì¶”ì²œ ì¹´ë“œ -->
      <div id="resultCard" class="card p-6 sm:p-7 bg-white/90 rounded-3xl shadow-xl border border-white/50 mobile-tight">
        <p class="text-xs sm:text-sm text-zinc-500">ì˜¤ëŠ˜ì˜ ì„ íƒ</p>
        <h2 id="resultText" class="mt-1 sm:mt-2 text-3xl sm:text-4xl md:text-5xl font-black leading-tight">ëœë¤ ì¶”ì²œ í´ë¦­!</h2>
        <p class="mt-2 text-[11px] sm:text-xs text-zinc-500">ë¦¬ë”ë³´ë“œì— ìˆëŠ” ê°€ê²Œ ì¤‘ì—ì„œ ëœë¤ìœ¼ë¡œ ê³¨ë¼ë“œë ¤ìš”.</p>
        <div class="mt-5 flex flex-col sm:flex-row gap-2">
          <button id="randomAll" class="w-full sm:w-auto px-4 py-3 rounded-2xl bg-gradient-to-r from-amber-400 to-pink-400 text-white font-semibold shadow">ğŸ² ëœë¤ ì¶”ì²œ</button>
          <button id="likeBtn" class="w-full sm:w-auto px-4 py-3 rounded-2xl border border-zinc-200 bg-white hover:bg-zinc-50">ğŸ‘ ì¢‹ì•„ìš”</button>
        </div>
      </div>

      <!-- ë¦¬ë”ë³´ë“œ / ì…ë ¥ -->
      <div class="p-6 sm:p-7 bg-white/90 rounded-3xl shadow-xl border border-white/50 mobile-tight">
        <h3 class="text-lg sm:text-xl font-bold mb-3">ğŸ”¥ ì¸ê¸° ê°€ê²Œ ë¦¬ë”ë³´ë“œ</h3>
        <div class="overflow-auto rounded-2xl border border-zinc-200 max-h-[260px] sm:max-h-[340px]">
          <table class="w-full text-xs sm:text-sm">
            <thead class="bg-zinc-50 sticky top-0">
              <tr><th class="px-3 sm:px-4 py-2 text-left">ìˆœìœ„</th><th class="px-3 sm:px-4 py-2 text-left">ê°€ê²Œ</th><th class="px-3 sm:px-4 py-2 text-right">ì¢‹ì•„ìš”</th></tr>
            </thead>
            <tbody id="leaderboard" class="bg-white"></tbody>
          </table>
        </div>

        <div class="mt-4 sm:mt-5">
          <h4 class="font-semibold mb-2">ê°€ê²Œ ì¶”ê°€</h4>
          <div class="flex flex-col sm:flex-row sm:flex-nowrap gap-2 items-stretch">
            <input id="placeName" class="px-3 py-2 border rounded-xl text-sm flex-[2] min-w-0" placeholder="ì‹œê·¸ë‹ˆì²˜ íƒ€ì›Œ" />
            <input id="placeCat"  class="px-3 py-2 border rounded-xl text-sm flex-1 min-w-0" list="catsList" placeholder="ì¹´í…Œê³ ë¦¬(ì„ íƒ)" />
            <datalist id="catsList"></datalist>
            <button id="addPlaceBtn" class="px-4 py-2 rounded-xl bg-zinc-900 text-white text-sm shrink-0 whitespace-nowrap">ì¶”ê°€</button>
          </div>
          <p class="text-[11px] sm:text-xs text-zinc-500 mt-1">ì¹´í…Œê³ ë¦¬ëŠ” ë¹„ì›Œë„ ë©ë‹ˆë‹¤. ìƒˆ ì´ë¦„ì„ ì ìœ¼ë©´ ìƒˆ ì¹´í…Œê³ ë¦¬ë¡œ ì €ì¥ë¼ìš”.</p>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-center text-[11px] sm:text-xs text-zinc-500">
      â“’ Jeongyeon. 2025
    </footer>
  </main>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyfLjdjQked5ZDMiQr219fW3BnsDBEaddK5aEviom9GQQT9fOwsKfRLkvdDwOgLiYtgzA/exec";
    const ADMIN_PASSWORD = "24003";
    const QR_TARGET_URL  = "https://taeja9.github.io/playground/lunch.html";

    const $ = (s)=>document.querySelector(s);
    const loadingModal=$("#loadingModal"),loadingEmojis=$("#loadingEmojis");
    const qrModal=$("#qrModal"),qrCanvas=$("#qrCanvas"),qrUrlText=$("#qrUrlText"),qrClose=$("#qrClose"),qrBtn=$("#qrBtn");
    const todayBadge=$("#todayBadge"),leaderBody=$("#leaderboard"),resultText=$("#resultText"),
          randomAll=$("#randomAll"),likeBtn=$("#likeBtn"),addPlaceBtn=$("#addPlaceBtn"),
          placeName=$("#placeName"),placeCat=$("#placeCat"),catsList=$("#catsList"),adminResetBtn=$("#adminResetBtn");

    let places=[],votes={},currentPick='';
    let toggled=JSON.parse(sessionStorage.getItem('lunch_like_toggle')||"{}");

    const LOADING_EMOJIS=["ğŸ•","ğŸ”","ğŸŸ","ğŸŒ­","ğŸ¿","ğŸ¥“","ğŸ³","ğŸ§‡","ğŸ¥","ğŸ","ğŸ¥","ğŸ¥¨","ğŸ¥ª","ğŸŒ®","ğŸ—","ğŸ›","ğŸ±","ğŸ£","ğŸ¥Ÿ","ğŸ","ğŸ‚"];
    const qs=(p)=>Object.entries(p).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
    const saveToggle=()=>sessionStorage.setItem('lunch_like_toggle',JSON.stringify(toggled));
    const setLikeBtnLabel=()=>{ likeBtn.textContent=currentPick?(toggled[currentPick]?"ğŸ™…â€â™€ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ":"ğŸ‘ ì¢‹ì•„ìš”"):"ğŸ‘ ì¢‹ì•„ìš”"; };

    function showLoading(msg="Loading..."){
      loadingEmojis.textContent = Array.from({length:5},()=>LOADING_EMOJIS[Math.floor(Math.random()*LOADING_EMOJIS.length)]).join('');
      loadingModal.querySelector("p").textContent=msg;
      loadingModal.classList.add("show");
    }
    function hideLoading(){ loadingModal.classList.remove("show"); }
    function formatTodayBadge(){
      const d=new Date(); const w=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
      todayBadge.textContent=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${w}ìš”ì¼`;
    }

    async function api(fn,params={}){ const r=await fetch(WEB_APP_URL+"?"+qs({fn,...params})); return r.json(); }
    async function withLoading(msg,fn){ showLoading(msg); try{ return await fn(); } finally{ hideLoading(); } }

    async function refresh(){
      await withLoading("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦", async ()=>{
        const s=await api("state");
        places=s.places||[]; votes=s.votes||{};
        renderLeaderboard(); renderCats(); setLikeBtnLabel();
      });
    }
    function renderCats(){ const cats=[...new Set(places.map(p=>p.cat).filter(Boolean))]; catsList.innerHTML=cats.map(c=>`<option value="${c}">`).join(""); }
    function renderLeaderboard(){
      const rows=places.map(p=>({n:p.name,v:votes[p.name]||0})).sort((a,b)=>b.v-a.v);
      leaderBody.innerHTML=rows.length?rows.map((r,i)=>`<tr><td class="px-3 py-2">${i+1}</td><td class="px-3 py-2">${r.n}</td><td class="px-3 py-2 text-right font-semibold">${r.v}</td></tr>`).join("")
        :`<tr><td colspan="3" class="px-3 py-3 text-center text-zinc-500">ê°€ê²Œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</td></tr>`;
    }
    function renderResult(n){
      if(!n){ resultText.textContent="ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘!"; setLikeBtnLabel(); return; }
      const em=["ğŸœ","ğŸ›","ğŸ•","ğŸ¥—","ğŸ£","ğŸ—","ğŸ¥ª","ğŸŒ®","ğŸ”","ğŸ¥Ÿ","ğŸ"];
      resultText.textContent=`${n} ${em[Math.floor(Math.random()*em.length)]}`;
      resultText.classList.remove("spring-in"); void resultText.offsetWidth; resultText.classList.add("spring-in");
      setLikeBtnLabel();
    }

    async function doVoteToggle(){
      if(!currentPick) return;
      await withLoading("ì¢‹ì•„ìš” ë°˜ì˜ ì¤‘â€¦", async ()=>{
        const was=toggled[currentPick]; const delta=was?-1:+1;
        const s=await api("vote",{name:currentPick,delta});
        votes=s.votes||{}; toggled[currentPick]=!was; saveToggle(); renderLeaderboard(); setLikeBtnLabel();
      });
    }
    async function doAdd(){
      const n=placeName.value.trim(), c=placeCat.value.trim(); if(!n) return;
      await withLoading("ê°€ê²Œ ì¶”ê°€ ì¤‘â€¦", async ()=>{
        const s=await api("add",{name:n,cat:c});
        places=s.places||[]; votes=s.votes||{};
        placeName.value=""; renderLeaderboard(); renderCats(); currentPick=n; renderResult(n);
      });
    }
    async function doAdminWipe(){
      const pw=prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:"); if(pw!==ADMIN_PASSWORD){ alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
      await withLoading("ì „ì²´ ë¹„ìš°ëŠ” ì¤‘â€¦", async ()=>{
        const s=await api("wipe");
        places=s.places||[]; votes=s.votes||{}; toggled={}; saveToggle();
        renderLeaderboard(); renderCats(); currentPick=""; renderResult("");
        alert("ì˜¤ëŠ˜ì˜ ì¶”ì²œì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ìˆœìœ„/ê°€ê²Œ/ì¢‹ì•„ìš” ì „ë¶€ ì´ˆê¸°í™”)");
      });
    }

    // QR ëª¨ë‹¬ (ì¤‘ì•™ ê³ ì • + í´ë°± ì´ë¯¸ì§€ëŠ” block/mx-auto)
    function openQrModal(){
      qrUrlText.textContent=QR_TARGET_URL;
      qrModal.classList.add("show");

      // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
      const ctx = qrCanvas.getContext && qrCanvas.getContext('2d');
      if (ctx) ctx.clearRect(0,0,qrCanvas.width||0,qrCanvas.height||0);

      // ê¸°ì¡´ í´ë°± ì´ë¯¸ì§€ ì œê±°
      const next = qrCanvas.nextElementSibling;
      if (next && next.dataset && next.dataset.qrimg === '1') next.remove();

      const encoded = encodeURIComponent(QR_TARGET_URL);
      const fallbackImg = () => {
        const img = new Image();
        img.width = 240; img.height = 240;
        img.alt = 'QR code';
        img.decoding = 'async';
        img.loading = 'eager';
        img.dataset.qrimg = '1';
        img.className = 'block mx-auto';   // â† ì¤‘ì•™ ì •ë ¬ ë³´ì¥
        img.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encoded}`;
        qrCanvas.insertAdjacentElement('afterend', img);
      };

      if (typeof QRCode !== 'undefined' && QRCode.toCanvas) {
        QRCode.toCanvas(qrCanvas, QR_TARGET_URL, { width: 240, margin: 1 }, (err) => {
          if (err) fallbackImg();
        });
      } else {
        fallbackImg();
      }
    }
    function closeQrModal(){ qrModal.classList.remove("show"); }

    // ì´ë²¤íŠ¸
    randomAll.onclick=()=>withLoading("ì¶”ì²œ ì¤‘â€¦",()=>{const pool=places.map(p=>p.name);if(!pool.length){currentPick="";renderResult("");return;}currentPick=pool[Math.floor(Math.random()*pool.length)];renderResult(currentPick);});
    likeBtn.onclick=doVoteToggle; addPlaceBtn.onclick=doAdd; adminResetBtn.onclick=doAdminWipe;
    document.getElementById('qrBtn').onclick=openQrModal;
    document.getElementById('qrClose').onclick=closeQrModal;
    qrModal.addEventListener('click', (e)=>{ if (e.target===qrModal) closeQrModal(); });

    formatTodayBadge(); refresh();
  </script>
</body>
</html>

